<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFL BEANO v2.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #f1f5f9;
            --accent: #38bdf8; 
            --gold: #fbbf24;
            --green: #22c55e;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Roboto', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3 { font-family: 'Teko', sans-serif; text-transform: uppercase; margin: 0; letter-spacing: 1px; }

        /* --- LOBBY --- */
        #lobby {
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
        .lobby-panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 16px;
            width: 90%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .lobby-panel h1 { font-size: 3.5rem; line-height: 1; margin-bottom: 5px; color: white; }
        .version { font-size: 0.8rem; color: #94a3b8; margin-bottom: 20px; display: block; font-family: monospace; }

        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        input, select {
            width: 100%; padding: 12px;
            background: #020617; border: 1px solid #334155;
            color: white; border-radius: 6px; font-size: 1rem;
            outline: none;
        }
        
        button {
            width: 100%; padding: 14px; font-size: 1.4rem; font-family: 'Teko', sans-serif;
            border: none; border-radius: 6px; cursor: pointer; transition: transform 0.1s;
            margin-top: 10px;
        }
        button:active { transform: scale(0.98); }
        .btn-host { background: var(--accent); color: #0f172a; }
        .btn-join { background: transparent; border: 1px solid #475569; color: #cbd5e1; }
        .btn-join:hover { border-color: white; color: white; }

        /* --- GAME UI --- */
        .hidden { display: none !important; }
        
        #game-ui { padding-bottom: 50px; }

        .header-bar {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid #334155;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(5px);
        }
        .room-badge {
            background: #334155; padding: 2px 8px; border-radius: 4px;
            font-family: monospace; color: var(--accent); font-size: 0.9rem;
        }

        .section-title {
            padding: 20px 20px 10px 20px;
            font-size: 1.5rem; color: white;
            border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .section-title small { font-size: 0.9rem; color: #64748b; font-family: sans-serif; font-weight: normal; }

        /* --- GRID SYSTEM --- */
        .player-grid {
            display: flex; flex-wrap: wrap; gap: 20px; padding: 20px;
            justify-content: center;
        }

        .player-block {
            background: #1e293b; border-radius: 12px; padding: 10px;
            border: 1px solid #334155;
            width: 100%; max-width: 340px;
            display: flex; flex-direction: column; gap: 10px;
            position: relative;
            transition: border-color 0.3s;
        }
        
        /* When someone wins */
        .player-block.winner {
            border: 2px solid var(--gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.2);
            animation: pulseBorder 2s infinite;
        }
        @keyframes pulseBorder { 0% { border-color: var(--gold); } 50% { border-color: white; } 100% { border-color: var(--gold); } }

        .player-name {
            text-align: center; font-family: 'Teko'; font-size: 1.5rem; 
            color: #cbd5e1; line-height: 1;
        }

        /* BINGO CARD */
        .bingo-card {
            background: black; border-radius: 6px; overflow: hidden;
        }
        
        .card-header {
            padding: 5px; text-align: center; font-weight: bold; font-size: 0.8rem;
            color: white; text-transform: uppercase; letter-spacing: 1px;
        }

        .grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 1px; background: #333; border-top: 1px solid #333;
            aspect-ratio: 1/1;
        }

        .cell {
            background: #f8fafc;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 0.65rem; padding: 2px;
            color: #0f172a; user-select: none; cursor: default;
            line-height: 1.1; word-break: break-word;
            font-weight: 500;
        }

        /* Styles for MY cards */
        .is-me .cell { cursor: pointer; font-size: 0.75rem; }
        .is-me .cell:active { background: #e2e8f0; }

        /* States */
        .cell.marked { background: var(--green) !important; color: white !important; text-decoration: line-through; }
        .cell.free { background: #0f172a !important; color: var(--accent) !important; font-weight: bold; border: none; }
        
        .cell.winning-line { background: var(--gold) !important; color: black !important; text-decoration: none; font-weight: bold; }

        /* Host Controls */
        #host-controls { 
            background: #0f172a; border-top: 1px solid #334155;
            padding: 10px; position: fixed; bottom: 0; width: 100%;
            display: flex; gap: 10px; justify-content: center;
            z-index: 900;
        }

        /* Celebration Overlay */
        #celebration {
            position: fixed; inset: 0; pointer-events: none; z-index: 2000; overflow: hidden;
        }
        .football {
            position: absolute; font-size: 3rem; 
            animation: flyAcross 3s linear infinite;
        }
        @keyframes flyAcross { 
            0% { transform: translate(-100px, 100px) rotate(0deg); } 
            100% { transform: translate(120vw, -100px) rotate(720deg); } 
        }

    </style>
</head>
<body>

    <!-- LOBBY SCREEN -->
    <div id="lobby">
        <div class="lobby-panel">
            <h1>NFL BEANO</h1>
            <span class="version">v2.0 - Stadium Edition</span>

            <div class="input-group">
                <label>Player Name</label>
                <input type="text" id="username" placeholder="Enter Name..." maxlength="12">
            </div>

            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                <div class="input-group">
                    <label>Cards Per Player</label>
                    <select id="card-count">
                        <option value="1">1 Card</option>
                        <option value="2">2 Cards</option>
                        <option value="3">3 Cards</option>
                        <option value="4">4 Cards</option>
                    </select>
                </div>
                <button class="btn-host" onclick="startHost()">HOST GAME</button>
            </div>

            <div style="margin: 20px 0; color: #64748b; font-size: 0.8rem;">â€” OR â€”</div>

            <div class="input-group">
                <label>Room Code</label>
                <input type="text" id="room-code-input" placeholder="ABCD" maxlength="4" style="text-transform:uppercase; text-align:center; letter-spacing:2px;">
            </div>
            <button class="btn-join" onclick="startJoin()">JOIN ROOM</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-ui" class="hidden">
        <div class="header-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <h2 style="color:white;">NFL BEANO</h2>
                <span class="room-badge" id="room-display">----</span>
            </div>
            <div>
                <select id="theme-select" onchange="updateTheme()" style="padding:5px; width:auto; font-size:0.8rem;">
                    <option value="None">Theme: Neutral</option>
                    <!-- Teams injected via JS -->
                </select>
            </div>
        </div>

        <!-- SECTION 1: MY HAND -->
        <div class="section-title">
            <span>MY HAND</span>
            <small>Click squares to mark</small>
        </div>
        <div id="my-area" class="player-grid"></div>

        <!-- SECTION 2: THE FIELD -->
        <div class="section-title">
            <span>THE FIELD</span>
            <small>Opponents Live View</small>
        </div>
        <div id="field-area" class="player-grid">
            <p style="color:#64748b; width:100%; text-align:center; padding:20px;">Waiting for players to join...</p>
        </div>

        <!-- HOST ONLY FOOTER -->
        <div id="host-controls" class="hidden">
            <button onclick="resetGame()" style="background:#ef4444; color:white; padding:10px; font-size:1rem; width:auto; margin:0;">RESET GAME / NEW CARDS</button>
        </div>
    </div>

    <div id="celebration"></div>

<script>
    // =================================================================
    // 1. DATA CONFIG
    // =================================================================
    const EVENTS = [
        "Touchdown", "Field Goal", "First Down", "2-Pt Conv", "QB Scramble", "4th Down Try", 
        "Pass > 20 Yds", "Run > 10 Yds", "3rd & Long", "Screen > 10", "Play Action", "QB Sneak", 
        "Hail Mary", "Empty Backfield", "Shotgun", "Trick Play", "Fake Punt", "Sack", "TFL", 
        "Pass Defended", "Tipped Pass", "Thrown Away", "Interception", "Fumble", "Turnover on Downs", 
        "Defensive TD", "Goal Line Stand", "3-and-Out", "Red Zone Stop", "Blocked Kick", "Penalty Flag", 
        "Holding", "False Start", "Pass Interference", "Delay of Game", "Intentional Grounding", 
        "Roughing Passer", "Face Mask", "Timeout", "2-Min Warning", "Challenge Flag", "Measurement", 
        "Overtime", "Injury", "Coach Yelling", "Mascot", "Blimp Shot", "Face Paint", "Shirtless Fan", 
        "Truck Ad", "Beer Ad", "Helmet Throw", "Cheerleader", "Celebrity", "Hurdle", "Juke", "One-Handed Catch"
    ];

    const TEAMS = {
        "None": "#1e293b", "ARI": "#97233F", "ATL": "#A71930", "BAL": "#241773", "BUF": "#00338D", 
        "CAR": "#0085CA", "CHI": "#0B162A", "CIN": "#FB4F14", "CLE": "#311D00", "DAL": "#041E42", 
        "DEN": "#FB4F14", "DET": "#0076B6", "GB": "#203731", "HOU": "#03202F", "IND": "#002C5F", 
        "JAX": "#006778", "KC": "#E31837", "LV": "#000000", "LAC": "#0080C6", "LAR": "#003594", 
        "MIA": "#008E97", "MIN": "#4F2683", "NE": "#002244", "NO": "#D3BC8D", "NYG": "#0B2265", 
        "NYJ": "#125740", "PHI": "#004C54", "PIT": "#FFB612", "SF": "#AA0000", "SEA": "#002244", 
        "TB": "#D50A0A", "TEN": "#0C2340", "WAS": "#5A1414"
    };

    const WINS = [
        [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], 
        [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], 
        [0,6,12,18,24], [4,8,12,16,20]
    ];

    const MQTT_HOST = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_PRE = 'nfl_beano_v2';

    // =================================================================
    // 2. STATE
    // =================================================================
    let client;
    let myId = 'p_' + Math.random().toString(36).substr(2, 6);
    let myName = "Player";
    let roomCode = "";
    let isHost = false;
    let currentTheme = "None";
    
    // THE MASTER STATE (Everyone has a full copy)
    let gameState = {
        players: {} // id -> { name, cards: [ { events:[], marked:[], winLine:[] } ] }
    };

    // Init Team Selector
    const ts = document.getElementById('theme-select');
    for(let t in TEAMS) {
        if(t!=="None") {
            let o = document.createElement('option');
            o.value = t; o.textContent = t;
            ts.appendChild(o);
        }
    }

    // =================================================================
    // 3. STARTUP LOGIC
    // =================================================================
    function startHost() {
        myName = document.getElementById('username').value.trim() || "Host";
        const count = parseInt(document.getElementById('card-count').value);
        roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
        isHost = true;

        // Host Generates their own cards immediately
        gameState.players[myId] = generatePlayer(myName, count);

        showGame();
        connectMQTT();
    }

    function startJoin() {
        myName = document.getElementById('username').value.trim() || "Guest";
        roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
        if(roomCode.length !== 4) return alert("Invalid Code");
        isHost = false;

        showGame();
        connectMQTT();
    }

    function showGame() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('room-display').textContent = roomCode;
        if(isHost) document.getElementById('host-controls').classList.remove('hidden');
        
        renderBoard();
    }

    function generatePlayer(name, count) {
        let p = { name: name, cards: [] };
        for(let i=0; i<count; i++) {
            let deck = [...EVENTS].sort(()=>Math.random()-0.5).slice(0, 24);
            deck.splice(12, 0, "FREE"); // Free space center
            p.cards.push({
                events: deck,
                marked: [12],
                winLine: []
            });
        }
        return p;
    }

    // =================================================================
    // 4. RENDERING
    // =================================================================
    function updateTheme() {
        currentTheme = document.getElementById('theme-select').value;
        renderBoard();
    }

    function renderBoard() {
        const myArea = document.getElementById('my-area');
        const fieldArea = document.getElementById('field-area');
        
        myArea.innerHTML = '';
        
        // Separate me from opponents
        const opponentIds = Object.keys(gameState.players).filter(id => id !== myId);
        
        if(opponentIds.length > 0) fieldArea.innerHTML = '';
        else fieldArea.innerHTML = '<p style="color:#64748b; width:100%; text-align:center; padding:20px;">Waiting for opponents...</p>';

        // Render Me
        if(gameState.players[myId]) {
            renderPlayerBlock(gameState.players[myId], true, myArea);
        }

        // Render Opponents
        opponentIds.forEach(pid => {
            renderPlayerBlock(gameState.players[pid], false, fieldArea);
        });
    }

    function renderPlayerBlock(pData, isMe, container) {
        const block = document.createElement('div');
        block.className = 'player-block ' + (isMe ? 'is-me' : '');

        // Check Winner
        const isWinner = pData.cards.some(c => c.winLine.length > 0);
        if(isWinner) block.classList.add('winner');

        // Header
        const nameDisplay = document.createElement('div');
        nameDisplay.className = 'player-name';
        nameDisplay.innerHTML = `${pData.name} ${isWinner ? 'ðŸ†' : ''}`;
        if(isWinner) nameDisplay.style.color = 'var(--gold)';
        block.appendChild(nameDisplay);

        // Cards
        pData.cards.forEach((card, cIdx) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'bingo-card';

            const head = document.createElement('div');
            head.className = 'card-header';
            head.textContent = `CARD ${cIdx+1}`;
            head.style.backgroundColor = isWinner ? 'var(--gold)' : TEAMS[currentTheme];
            if(isWinner) head.style.color = 'black';
            cardDiv.appendChild(head);

            const grid = document.createElement('div');
            grid.className = 'grid';

            card.events.forEach((txt, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = txt;

                if(idx===12) cell.classList.add('free');
                if(card.marked.includes(idx)) cell.classList.add('marked');
                if(card.winLine.includes(idx)) cell.classList.add('winning-line');

                // CLICK HANDLER
                if(isMe) {
                    cell.onclick = () => {
                        if(idx===12) return;
                        
                        // Logic
                        if(card.marked.includes(idx)) card.marked = card.marked.filter(x=>x!==idx);
                        else card.marked.push(idx);

                        // Win Check
                        const w = checkWin(card.marked);
                        if(w) {
                            card.winLine = w;
                            triggerCelebration();
                        } else {
                            card.winLine = [];
                        }

                        // Render & Send
                        renderBoard();
                        send({ type: 'UPDATE', pData: pData });
                    };
                }

                grid.appendChild(cell);
            });

            cardDiv.appendChild(grid);
            block.appendChild(cardDiv);
        });

        container.appendChild(block);
    }

    function checkWin(marks) {
        for(let line of WINS) {
            if(line.every(i => marks.includes(i))) return line;
        }
        return null;
    }

    // =================================================================
    // 5. NETWORKING
    // =================================================================
    function connectMQTT() {
        client = mqtt.connect(MQTT_HOST);
        const topic = `${TOPIC_PRE}/${roomCode}`;

        client.on('connect', () => {
            client.subscribe(topic);

            if(isHost) {
                // Host Loop: Broadcast full state
                setInterval(() => {
                    send({ type: 'STATE', state: gameState });
                }, 1000);
            } else {
                // Guest Loop: Knock
                let tries = 0;
                const loop = setInterval(() => {
                    if(gameState.players[myId]) clearInterval(loop); // We are in
                    else {
                        send({ type: 'JOIN', name: myName });
                        tries++;
                    }
                }, 2000);
            }
        });

        client.on('message', (t, m) => {
            const msg = JSON.parse(m.toString());
            if(msg.sender === myId) return; // Ignore self

            if(isHost) {
                if(msg.type === 'JOIN') {
                    if(!gameState.players[msg.sender]) {
                        // Create player matching host card count
                        const count = gameState.players[myId].cards.length;
                        gameState.players[msg.sender] = generatePlayer(msg.name, count);
                        renderBoard();
                    }
                }
                if(msg.type === 'UPDATE') {
                    gameState.players[msg.sender] = msg.pData;
                    // Did they win?
                    if(msg.pData.cards.some(c => c.winLine.length>0)) triggerCelebration();
                    renderBoard();
                }
            } else {
                if(msg.type === 'STATE') {
                    // Merge: Don't overwrite my local object to prevent click lag
                    const myLocal = gameState.players[myId];
                    gameState = msg.state;
                    if(myLocal) gameState.players[myId] = myLocal; // Keep my clicks trusted
                    
                    // Check celebration
                    const someoneWon = Object.values(gameState.players).some(p => p.cards.some(c => c.winLine.length > 0));
                    if(someoneWon && !window.hasCeleb) {
                        triggerCelebration();
                        window.hasCeleb = true; // prevent spam
                    }

                    renderBoard();
                }
            }
        });
    }

    function send(payload) {
        payload.sender = myId;
        client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(payload));
    }

    // =================================================================
    // 6. EXTRAS
    // =================================================================
    function resetGame() {
        if(!isHost) return;
        if(confirm("Generate new cards for everyone?")) {
            Object.keys(gameState.players).forEach(pid => {
                const name = gameState.players[pid].name;
                const count = gameState.players[pid].cards.length;
                gameState.players[pid] = generatePlayer(name, count);
            });
            window.hasCeleb = false;
            renderBoard();
        }
    }

    function triggerCelebration() {
        const box = document.getElementById('celebration');
        // Spawn 10 footballs
        for(let i=0; i<10; i++) {
            let fb = document.createElement('div');
            fb.className = 'football';
            fb.textContent = 'ðŸˆ';
            fb.style.top = Math.random() * 80 + 'vh';
            fb.style.animationDuration = (Math.random() * 2 + 2) + 's';
            fb.style.animationDelay = (Math.random()) + 's';
            box.appendChild(fb);
            setTimeout(() => fb.remove(), 4000);
        }
    }

</script>
</body>
</html>
