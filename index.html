<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Bingo Party</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --primary: #004C54;
            --secondary: #ffffff;
            --highlight: #fca311;
            --bg: #f4f7f6;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; overflow-x: hidden; }
        h1, h2, h3 { margin: 0; text-align: center; }

        /* --- LOBBY --- */
        .lobby-container { max-width: 500px; margin: 40px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, button { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .or-divider { text-align: center; margin: 20px 0; color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .join-btn { background: #555; }

        /* --- GAME UI --- */
        .game-container { max-width: 1200px; margin: 0 auto; display: none; }
        
        /* HOST CONTROLS */
        .host-dashboard { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .room-badge { background: #eee; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-family: monospace; font-size: 1.2rem; }
        
        /* CARDS LAYOUT */
        .cards-wrapper { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        
        .bingo-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 380px;
            flex: 0 0 auto;
            transition: transform 0.2s;
        }
        
        .card-header {
            background: var(--primary);
            color: var(--secondary);
            padding: 12px;
            text-align: center;
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* GRID */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            aspect-ratio: 1/1;
            border-top: 1px solid #ccc;
        }
        .square {
            border: 1px solid #ececec;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 11px;
            padding: 3px;
            cursor: pointer;
            user-select: none;
            background: #fff;
            line-height: 1.1;
            word-wrap: break-word;
        }
        .square:hover { background: #f9f9f9; }
        
        /* STATES */
        .marked { background-color: #d1fae5 !important; color: #065f46; text-decoration: line-through; opacity: 0.9; }
        .free-space { background-color: var(--primary) !important; color: var(--secondary) !important; font-weight: 900; font-size: 14px; text-decoration: none !important; }
        
        .winning-card { border: 4px solid #fca311; transform: scale(1.02); }
        .winning-line { background-color: #fca311 !important; color: white !important; text-decoration: none; transform: scale(1.05); transition: 0.3s; font-weight: bold; }

        /* SCOREBOARD */
        .scoreboard { position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 250px; z-index: 99; display: none; max-height: 300px; overflow-y: auto; }
        .score-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; font-size: 14px; }

        /* CELEBRATION OVERLAY */
        #celebration-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; color: white; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        #celebration-overlay.active { opacity: 1; pointer-events: auto; }
        #winner-name { font-size: 4rem; font-weight: 900; text-transform: uppercase; color: #fca311; text-shadow: 0 0 20px red; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* FOOTBALL ANIMATION */
        .football { position: fixed; font-size: 50px; z-index: 999; opacity: 0.8; }
        @keyframes flyLeft { from { transform: translateX(-10vw) rotate(0deg); } to { transform: translateX(110vw) rotate(360deg); } }
        @keyframes flyRight { from { transform: translateX(110vw) rotate(0deg); } to { transform: translateX(-10vw) rotate(-360deg); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 1. LOBBY -->
    <div class="lobby-container" id="lobby">
        <h1>üèà NFL Bingo</h1>
        <div class="input-group" style="margin-top:20px;">
            <label>Your Name</label>
            <input type="text" id="username" placeholder="E.g. Switch">
        </div>

        <!-- Host Section -->
        <div style="background: #f8f9fa; padding:15px; border-radius:8px; border:1px solid #eee;">
            <h3>Host New Game</h3>
            <div class="input-group">
                <label>Cards per Player</label>
                <select id="cards-count">
                    <option value="1">1 Card</option>
                    <option value="2">2 Cards</option>
                    <option value="3">3 Cards</option>
                    <option value="4">4 Cards</option>
                </select>
            </div>
            <button onclick="hostGame()">Create Room & Play</button>
        </div>

        <div class="or-divider">OR</div>

        <!-- Join Section -->
        <div style="background: #f8f9fa; padding:15px; border-radius:8px; border:1px solid #eee;">
            <h3>Join Existing</h3>
            <div class="input-group">
                <label>Room Code</label>
                <input type="text" id="room-code-input" placeholder="ABCD" style="text-transform:uppercase" maxlength="4">
            </div>
            <button class="join-btn" onclick="joinGame()">Enter Room</button>
        </div>
    </div>

    <!-- 2. GAME AREA -->
    <div class="game-container" id="game">
        <!-- Top Controls -->
        <div class="host-dashboard">
            <div class="room-badge">Room: <span id="room-display">----</span></div>
            <select id="team-select" onchange="updateTeamColor()">
                <option value="None">-- Pick Active Team --</option>
                <!-- Teams populated via JS -->
            </select>
            <!-- Host Only Button -->
            <button id="reset-btn" onclick="resetGame()" class="hidden" style="width:auto; background:#d9534f;">New Cards</button>
        </div>

        <!-- Where YOUR cards go -->
        <div class="cards-wrapper" id="my-cards"></div>

        <!-- Host Scoreboard -->
        <div class="scoreboard" id="scoreboard">
            <h4 style="margin-bottom:10px; border-bottom:2px solid #333;">Live Scoreboard</h4>
            <div id="score-list"></div>
        </div>
    </div>

    <!-- 3. CELEBRATION OVERLAY -->
    <div id="celebration-overlay">
        <h2>BEANO!</h2>
        <div id="winner-name">PLAYER</div>
        <p style="margin-top:20px; font-size:1.2rem;">Click anywhere to close</p>
    </div>

<script>
    // ============================================================
    // DATA: Categories & Teams
    // ============================================================
    
    const EVENTS = {
        offense: [ "Touchdown", "Field Goal", "First Down", "Two-Point Conversion", "Quarterback Scramble", "4th Down Attempt", "Over 20-Yard Pass", "Over 10-Yard Run", "3rd and Long (>10 yds)", "Screen Pass > 10 yards", "Play Action Pass", "Quarterback Sneak", "Hail Mary", "Empty Backfield", "I-Formation", "Shotgun Formation", "5+ Wide Receivers", "Offensive Lineman Reports as Eligible", "No Huddle Offense", "Trick Play", "Fake Punt" ],
        defense: [ "Sack", "Tackle for Loss", "Pass Defended", "Tipped Pass", "QB Throws Ball Away", "Interception", "Fumble", "Forced Fumble", "Running Back Fumble", "Wide Receiver Fumble", "Turnover on Downs", "Defensive Touchdown", "Goal line stand", "Three and Out", "Hold to FG (Red Zone)", "3rd Down Stop", "Tackle by Kicker / Punter", "Muffed Punt", "Blocked Punt", "Defensive Points" ],
        penalties: [ "Penalty Flag", "Holding Penalty", "False Start", "Pass Interference", "Delay of Game", "Intentional Grounding", "Roughing the Passer", "Unnecessary Roughness", "Face Mask Penalty", "Illegal Block in the Back", "Running into the Kicker", "Penalty Declined", "Penalty Accepted" ],
        specialTeams: [ "Punt", "Kickoff Touchback", "Missed Field Goal", "Onside Kick Attempt", "Successful Onside Kick", "Special Teams Touchdown", "Field Goal Kicks Off Post" ],
        gameManagement: [ "Timeout", "Two Minute Warning", "Score in Final 2 Minutes", "Back-to-Back Timeouts", "Challenge Flag", "Successful Challenge", "Unsuccessful Challenge", "Measurement with Chains", "Overtime", "Player Injury Timeout", "Spiked Ball" ],
        flavor: [ "Coach Yelling at Ref", "Mascot on Screen", "Blimp Shot", "Sideline Reporter", "Rules Expert", "Fan with Face Paint", "Shirtless Fan", "Commercial for a truck", "Commercial for beer", "Announcers Disagree", "Sideline Helmet Throw", "Lip Readable Profanity", "Cheerleader on Screen", "Celebrity in Stands", "Hurdle", "Announcer Calls Juke Move", "Announcer Calls Stiff Arm", "One-Handed Catch", "Drop", "Free for Switch / Sack for loss of 5+", "Announcing Team on Camera" ]
    };

    const TEAMS = {
        "None": "#fca311", "ARI": "#97233F", "ATL": "#A71930", "BAL": "#241773", "BUF": "#00338D", "CAR": "#0085CA", "CHI": "#0B162A", "CIN": "#FB4F14", "CLE": "#311D00", "DAL": "#041E42", "DEN": "#FB4F14", "DET": "#0076B6", "GB": "#203731", "HOU": "#03202F", "IND": "#002C5F", "JAX": "#006778", "KC": "#E31837", "LV": "#000000", "LAC": "#0080C6", "LAR": "#003594", "MIA": "#008E97", "MIN": "#4F2683", "NE": "#002244", "NO": "#D3BC8D", "NYG": "#0B2265", "NYJ": "#125740", "PHI": "#004C54", "PIT": "#FFB612", "SF": "#AA0000", "SEA": "#002244", "TB": "#D50A0A", "TEN": "#0C2340", "WAS": "#5A1414"
    };

    // Winning patterns (Indices 0-24)
    const WINS = [
        [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], // Horiz
        [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], // Vert
        [0,6,12,18,24], [4,8,12,16,20] // Diag
    ];

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    
    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const APP_TOPIC = 'nfl-beano-party/v1'; // Prefix

    let client;
    let myId = 'p-' + Math.random().toString(36).substr(2,6);
    let myName = "Player";
    let roomCode = "";
    let isHost = false;
    
    // THE GAME STATE
    let gameState = {
        cardsPerPlayer: 1,
        activeTeam: "None",
        players: {} // id -> { name, cards: [{ events:[], marked:[], bingo: false }] }
    };

    // ============================================================
    // LOBBY & INIT
    // ============================================================

    // Fill Team Select
    const teamSel = document.getElementById('team-select');
    Object.keys(TEAMS).forEach(t => {
        if(t!=="None") {
            let opt = document.createElement('option');
            opt.value = t; opt.textContent = t;
            teamSel.appendChild(opt);
        }
    });

    function hostGame() {
        myName = document.getElementById('username').value.trim() || "The Host";
        const count = parseInt(document.getElementById('cards-count').value);
        roomCode = generateCode();
        isHost = true;

        // Initialize Host State
        gameState.cardsPerPlayer = count;
        gameState.players[myId] = createPlayer(myName, count);

        startGame();
        connectMQTT();
    }

    function joinGame() {
        myName = document.getElementById('username').value.trim() || "Guest";
        roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
        if(!roomCode || roomCode.length !== 4) return alert("Invalid Room Code");
        isHost = false;
        
        startGame();
        connectMQTT();
    }

    function startGame() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.getElementById('room-display').textContent = roomCode;
        
        if(isHost) {
            document.getElementById('reset-btn').classList.remove('hidden');
            document.getElementById('scoreboard').style.display = 'block';
            render(); // Render Host's cards immediately
        }
    }

    function generateCode() {
        const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let r = "";
        for(let i=0;i<4;i++) r += c.charAt(Math.floor(Math.random()*c.length));
        return r;
    }

    // ============================================================
    // ALGORITHMS (The Core Logic)
    // ============================================================

    function createPlayer(name, numCards) {
        let p = { name: name, cards: [] };
        for(let i=0; i<numCards; i++) {
            p.cards.push({
                events: generateBoardEvents(),
                marked: [12], // Free space
                bingo: false,
                winningIndices: []
            });
        }
        return p;
    }

    // THE ORIGINAL ALGORITHM from provided script
    function generateBoardEvents() {
        const dist = { offense: 6, defense: 6, penalties: 3, specialTeams: 2, gameManagement: 2, flavor: 5 };
        let selected = [];
        
        // 1. Pull from categories
        Object.entries(dist).forEach(([cat, count]) => {
            let pool = [...EVENTS[cat]]; 
            pool.sort(() => Math.random() - 0.5);
            selected.push(...pool.slice(0, count));
        });

        // 2. Fill if short (unlikely but safe)
        if (selected.length < 24) {
            let all = Object.values(EVENTS).flat();
            let rem = all.filter(e => !selected.includes(e));
            rem.sort(() => Math.random() - 0.5);
            selected.push(...rem.slice(0, 24 - selected.length));
        }

        // 3. Shuffle
        selected.sort(() => Math.random() - 0.5);

        // 4. Insert Free Space
        selected.splice(12, 0, "FREE SPACE");
        
        return selected;
    }

    function checkWin(card) {
        for(let combo of WINS) {
            if(combo.every(idx => card.marked.includes(idx))) {
                return combo; // Return winning line indices
            }
        }
        return null;
    }

    // ============================================================
    // NETWORKING (MQTT)
    // ============================================================

    function connectMQTT() {
        client = mqtt.connect(BROKER);
        const topic = `${APP_TOPIC}/${roomCode}`;
        
        client.on('connect', () => {
            console.log('Connected to ' + topic);
            client.subscribe(topic);

            if(isHost) {
                // Host Heartbeat
                setInterval(() => {
                    send({ type: 'STATE', data: gameState });
                }, 500); // Fast updates
            } else {
                // Client Join Loop
                let joinInt = setInterval(() => {
                    if(gameState.players[myId]) clearInterval(joinInt);
                    else send({ type: 'JOIN', name: myName });
                }, 1500);
            }
        });

        client.on('message', (t, m) => {
            const msg = JSON.parse(m.toString());
            if(msg.sender === myId) return; // Ignore self

            if(isHost) handleHostMsg(msg);
            else handleClientMsg(msg);
        });
    }

    function send(payload) {
        payload.sender = myId;
        client.publish(`${APP_TOPIC}/${roomCode}`, JSON.stringify(payload));
    }

    // --- HOST LOGIC ---
    function handleHostMsg(msg) {
        if(msg.type === 'JOIN') {
            if(!gameState.players[msg.sender]) {
                // Create player with correct config
                gameState.players[msg.sender] = createPlayer(msg.name, gameState.cardsPerPlayer);
            }
        } else if (msg.type === 'CLICK') {
            // Player clicked something
            let p = gameState.players[msg.sender];
            if(p) {
                let c = p.cards[msg.cardIdx];
                let sqIdx = msg.sqIdx;
                
                // Toggle logic
                if(c.marked.includes(sqIdx)) c.marked = c.marked.filter(x => x !== sqIdx);
                else c.marked.push(sqIdx);

                // Win Check
                let winLine = checkWin(c);
                if(winLine) {
                    if(!c.bingo) { // New Bingo!
                        c.bingo = true;
                        c.winningIndices = winLine;
                        send({ type: 'WINNER', name: p.name }); // Trigger celebration immediately
                    }
                } else {
                    c.bingo = false;
                    c.winningIndices = [];
                }
            }
        }
    }

    // --- CLIENT LOGIC ---
    function handleClientMsg(msg) {
        if(msg.type === 'STATE') {
            gameState = msg.data;
            render();
        } else if (msg.type === 'WINNER') {
            launchCelebration(msg.name);
        }
    }

    // ============================================================
    // RENDERING & INTERACTION
    // ============================================================

    function render() {
        // 1. Theme Colors
        let color = TEAMS[gameState.activeTeam] || TEAMS["None"];
        document.documentElement.style.setProperty('--primary', color);

        // 2. My Cards
        let myData = gameState.players[myId];
        let container = document.getElementById('my-cards');
        
        if(!myData) {
            container.innerHTML = '<p style="text-align:center; width:100%;">Connecting to Host...</p>';
            return;
        }

        // Rebuild only if count changes (lazy diff)
        let domCards = container.querySelectorAll('.bingo-card');
        if(domCards.length !== myData.cards.length) {
            container.innerHTML = '';
            myData.cards.forEach((c, i) => container.appendChild(buildCardDOM(c, i)));
        } else {
            // Just update classes
            myData.cards.forEach((c, i) => updateCardDOM(domCards[i], c));
        }

        // 3. Scoreboard (Host Only)
        if(isHost) {
            let list = document.getElementById('score-list');
            list.innerHTML = '';
            Object.values(gameState.players).forEach(p => {
                let row = document.createElement('div');
                row.className = 'score-row';
                
                // Calculate progress
                let totalMarks = p.cards.reduce((acc, c) => acc + (c.marked.length - 1), 0);
                let bingos = p.cards.filter(c => c.bingo).length;
                
                row.innerHTML = `<b>${p.name}</b> <span>${bingos > 0 ? 'üèÜ BEANO!' : totalMarks}</span>`;
                if(bingos > 0) row.style.color = '#fca311';
                list.appendChild(row);
            });
        }
    }

    function buildCardDOM(cardData, idx) {
        let div = document.createElement('div');
        div.className = 'bingo-card';
        div.innerHTML = `
            <div class="card-header">
                <span>CARD ${idx+1}</span>
                <span class="bingo-badge hidden">üèÜ BEANO!</span>
            </div>
            <div class="bingo-grid"></div>
        `;
        
        let grid = div.querySelector('.bingo-grid');
        cardData.events.forEach((txt, sqIdx) => {
            let sq = document.createElement('div');
            sq.className = 'square';
            sq.innerText = txt;
            if(sqIdx === 12) sq.classList.add('free-space');
            
            sq.onclick = () => {
                if(sqIdx === 12) return;
                // Optimistic update
                sq.classList.toggle('marked');
                send({ type: 'CLICK', cardIdx: idx, sqIdx: sqIdx });
            };
            grid.appendChild(sq);
        });
        
        return div;
    }

    function updateCardDOM(div, cardData) {
        // Update Badge
        let badge = div.querySelector('.bingo-badge');
        if(cardData.bingo) {
            div.classList.add('winning-card');
            badge.classList.remove('hidden');
        } else {
            div.classList.remove('winning-card');
            badge.classList.add('hidden');
        }

        // Update Squares
        let squares = div.querySelectorAll('.square');
        squares.forEach((sq, i) => {
            // Mark check
            if(cardData.marked.includes(i)) sq.classList.add('marked');
            else if (i !== 12) sq.classList.remove('marked');
            
            // Winning Line Highlight
            if(cardData.winningIndices.includes(i)) sq.classList.add('winning-line');
            else sq.classList.remove('winning-line');
        });
    }

    // ============================================================
    // GAME CONTROLS
    // ============================================================

    function updateTeamColor() {
        let team = document.getElementById('team-select').value;
        gameState.activeTeam = team;
        // Loop will broadcast this change
    }

    function resetGame() {
        if(confirm("Resetting will generate NEW CARDS for everyone. Sure?")) {
            // Regenerate everyone
            Object.keys(gameState.players).forEach(pid => {
                let p = gameState.players[pid];
                // Re-run create logic, keeping name and count
                gameState.players[pid] = createPlayer(p.name, gameState.cardsPerPlayer);
            });
        }
    }

    // ============================================================
    // CELEBRATION (The Cool Part)
    // ============================================================

    function launchCelebration(name) {
        const overlay = document.getElementById('celebration-overlay');
        const winName = document.getElementById('winner-name');
        
        winName.innerText = name + " WINS!";
        overlay.classList.add('active');
        
        // Spawn Footballs
        for(let i=0; i<20; i++) {
            spawnFootball();
        }

        // Click to dismiss
        overlay.onclick = () => overlay.classList.remove('active');
        
        // Auto dismiss after 5s
        setTimeout(() => overlay.classList.remove('active'), 5000);
    }

    function spawnFootball() {
        const fb = document.createElement('div');
        fb.innerText = "üèà";
        fb.className = 'football';
        
        // Random Start Y
        const startY = Math.random() * 80 + 10; // 10% to 90% height
        fb.style.top = startY + "vh";
        
        // Duration
        const duration = Math.random() * 2 + 1; // 1s to 3s
        fb.style.animationDuration = duration + 's';
        
        // Direction (Left to Right or Right to Left)
        if(Math.random() > 0.5) {
            fb.style.left = "-10vw";
            fb.style.animationName = "flyLeft";
        } else {
            fb.style.left = "110vw";
            fb.style.animationName = "flyRight";
        }

        document.body.appendChild(fb);
        
        // Cleanup
        setTimeout(() => fb.remove(), duration * 1000);
    }

</script>
</body>
</html>
