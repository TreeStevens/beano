<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFL BEANO v5.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Black+Han+Sans&display=swap" rel="stylesheet">

    <style>
        :root {
            --my-bg: #1e293b;
            --my-accent: #ffffff;
            --field-bg: #0f172a;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Chakra Petch', sans-serif;
            background: #000;
            color: white;
            overflow-x: hidden;
        }

        /* --- LOBBY --- */
        #lobby {
            position: fixed; inset: 0; z-index: 2000;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
        }
        .lobby-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 40px; border-radius: 20px;
            width: 100%; max-width: 450px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        h1 { font-family: 'Black Han Sans', sans-serif; font-size: 4rem; margin: 0; line-height: 1; text-transform: uppercase; color: #fff; text-shadow: 0 4px 0px #000; }
        
        .control-group { margin: 20px 0; text-align: left; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        input, select {
            width: 100%; padding: 15px;
            background: #020617; border: 2px solid #334155; color: white;
            border-radius: 8px; font-size: 1.1rem; outline: none; font-family: 'Chakra Petch', sans-serif;
        }
        input:focus, select:focus { border-color: #38bdf8; }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        button {
            flex: 1; padding: 15px;
            font-family: 'Black Han Sans', sans-serif; font-size: 1.5rem;
            border: none; border-radius: 8px; cursor: pointer;
            text-transform: uppercase; transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-host { background: #fbbf24; color: black; }
        .btn-join { background: transparent; border: 2px solid #475569; color: white; }

        /* --- GAME LAYOUT --- */
        #game-ui {
            display: flex; min-height: 100vh;
        }
        
        /* Left Side: MY HAND */
        .pane-my-hand {
            flex: 6;
            background: var(--my-bg);
            padding: 20px;
            border-right: 4px solid rgba(0,0,0,0.2);
            transition: background 0.5s;
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* Right Side: THE FIELD */
        .pane-field {
            flex: 4;
            background: var(--field-bg);
            padding: 20px;
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center;
            min-width: 320px;
        }

        .pane-title {
            font-family: 'Black Han Sans', sans-serif; font-size: 2.5rem;
            text-transform: uppercase; margin-bottom: 20px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        /* --- PLAYER WRAPPER --- */
        .player-container { width: 100%; display: flex; flex-direction: column; gap: 20px; }

        .player-block {
            background: rgba(255,255,255,0.1);
            border-radius: 15px; padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .player-block.me {
            background: transparent; border: none; padding: 0;
        }

        .player-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
            justify-content: center;
        }
        .player-name { font-size: 1.5rem; font-weight: bold; text-transform: uppercase; }
        .team-logo { width: 40px; height: 40px; object-fit: contain; }

        /* --- CARDS LAYOUT --- */
        .cards-row {
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
        }

        .bingo-card-wrap {
            display: flex; flex-direction: column; gap: 10px;
            flex: 1 1 280px; max-width: 340px; min-width: 280px;
        }

        .bingo-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .card-top {
            background: #333; color: white; text-align: center;
            padding: 8px; font-weight: bold; font-size: 0.9rem; text-transform: uppercase;
        }

        .grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 1px; background: #ccc; border: 2px solid #ccc; aspect-ratio: 1/1;
        }

        .cell {
            background: #f1f5f9; color: #0f172a;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 10px; padding: 2px;
            font-weight: 700; line-height: 1.1;
            word-break: normal; user-select: none; cursor: default;
        }
        .me .cell { cursor: pointer; }
        .me .cell:active { background: #e2e8f0; }

        .cell.marked { background: #16a34a !important; color: white !important; }
        .cell.winning-line { background: #fbbf24 !important; color: black !important; }
        .cell.free { background: #333 !important; color: white !important; font-size: 11px; font-weight: 900; }

        /* --- REROLL UI --- */
        .reroll-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px;
        }
        .reroll-btn {
            background: #ef4444; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
        }
        .reroll-btn:disabled { background: #555; opacity: 0.6; cursor: not-allowed; }
        .reroll-info { font-size: 0.8rem; opacity: 0.8; }

        /* --- HEADER & FOOTER --- */
        .game-header-controls {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            background: white; padding: 10px 20px; border-radius: 50px;
            display: flex; gap: 15px; align-items: center; color: black;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- ANIMATIONS --- */
        #celebration { position: fixed; inset: 0; pointer-events: none; z-index: 3000; }
        .football { position: absolute; font-size: 4rem; animation: fly 3s linear infinite; }
        @keyframes fly { from { transform: translateX(-10vw) rotate(0deg); } to { transform: translateX(110vw) rotate(720deg); } }

        .hidden { display: none !important; }
        
        /* Opponent scaling */
        .pane-field .bingo-card { transform: scale(0.95); transform-origin: top center; }

        @media (max-width: 800px) {
            #game-ui { flex-direction: column; }
            .pane-my-hand { min-height: 60vh; border-right: none; border-bottom: 4px solid rgba(0,0,0,0.2); }
            .pane-field { min-height: 40vh; }
        }
    </style>
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby">
        <div class="lobby-card">
            <h1>NFL BEANO</h1>
            <p style="color:#94a3b8; margin-bottom:30px; font-weight:bold; letter-spacing:1px;">GAME DAY EDITION v5.0</p>

            <div class="control-group">
                <label>Player Name</label>
                <input type="text" id="username" placeholder="e.g. Stevens" maxlength="12">
            </div>

            <div class="control-group">
                <label>Your Team</label>
                <select id="team-select"></select>
            </div>

            <div class="control-group">
                <label>Cards to Play</label>
                <select id="card-count">
                    <option value="1">1 Card</option>
                    <option value="2">2 Cards</option>
                    <option value="3">3 Cards</option>
                </select>
            </div>

            <div class="btn-row">
                <button class="btn-host" onclick="createGame()">HOST</button>
                <button class="btn-join" onclick="joinGame()">JOIN</button>
            </div>

            <div style="margin-top:15px;">
                <input type="text" id="room-code" placeholder="ROOM CODE (For Joining)" style="text-align:center; text-transform:uppercase;">
            </div>
        </div>
    </div>

    <!-- GAME UI -->
    <div id="game-ui" class="hidden">
        
        <!-- MY HAND -->
        <div class="pane-my-hand" id="pane-my-hand">
            <div class="pane-title">MY HAND</div>
            <div id="my-area" class="player-container" style="align-items:center;"></div>
        </div>

        <!-- THE FIELD -->
        <div class="pane-field">
            <div class="pane-title">THE FIELD</div>
            <div id="field-area" class="player-container"></div>
        </div>

        <!-- CONTROLS -->
        <div class="game-header-controls">
            <strong id="room-display">----</strong>
            <select id="ingame-team" onchange="updateTeam()" style="padding:5px; width:auto; font-size:0.8rem; border:1px solid #ccc; background:white; color:black;"></select>
            <button id="reset-btn" onclick="resetGame()" style="font-size:0.8rem; padding:5px 10px; background:#ef4444; color:white; display:none;">RESET</button>
        </div>
    </div>

    <div id="celebration"></div>

<script>
    // =================================================================
    // 1. CONFIG
    // =================================================================
    const TEAMS = {
        "None": { p: "#334155", s: "#ffffff" },
        "ARI": { p: "#97233F", s: "#000000" }, "ATL": { p: "#A71930", s: "#000000" },
        "BAL": { p: "#241773", s: "#9E7C0C" }, "BUF": { p: "#00338D", s: "#C60C30" },
        "CAR": { p: "#0085CA", s: "#000000" }, "CHI": { p: "#0B162A", s: "#C83803" },
        "CIN": { p: "#FB4F14", s: "#000000" }, "CLE": { p: "#311D00", s: "#FF3C00" },
        "DAL": { p: "#003594", s: "#869397" }, "DEN": { p: "#FB4F14", s: "#002244" },
        "DET": { p: "#0076B6", s: "#B0B7BC" }, "GB":  { p: "#203731", s: "#FFB612" },
        "HOU": { p: "#03202F", s: "#A71930" }, "IND": { p: "#002C5F", s: "#A2AAAD" },
        "JAX": { p: "#006778", s: "#9F792C" }, "KC":  { p: "#E31837", s: "#FFB81C" },
        "LV":  { p: "#000000", s: "#A5ACAF" }, "LAC": { p: "#0080C6", s: "#FFC20E" },
        "LAR": { p: "#003594", s: "#FFD100" }, "MIA": { p: "#008E97", s: "#FC4C02" },
        "MIN": { p: "#4F2683", s: "#FFC62F" }, "NE":  { p: "#002244", s: "#C60C30" },
        "NO":  { p: "#D3BC8D", s: "#101820" }, "NYG": { p: "#0B2265", s: "#A71930" },
        "NYJ": { p: "#125740", s: "#FFFFFF" }, "PHI": { p: "#004C54", s: "#A5ACAF" },
        "PIT": { p: "#FFB612", s: "#101820" }, "SF":  { p: "#AA0000", s: "#B3995D" },
        "SEA": { p: "#002244", s: "#69BE28" }, "TB":  { p: "#D50A0A", s: "#34302B" },
        "TEN": { p: "#0C2340", s: "#4B92DB" }, "WAS": { p: "#5A1414", s: "#FFB612" }
    };

    const EVENTS = [
        "Touchdown", "Field Goal", "First Down", "2-Pt Conv", "QB Scramble", "4th Down Try", 
        "Pass > 20 Yds", "Run > 10 Yds", "3rd & Long", "Screen > 10", "Play Action", "QB Sneak", 
        "Hail Mary", "Empty Backfield", "Shotgun", "Trick Play", "Fake Punt", "Sack", "TFL", 
        "Pass Defended", "Tipped Pass", "Thrown Away", "Interception", "Fumble", "Turnover", 
        "Defensive TD", "Goal Line Stand", "3-and-Out", "Red Zone Stop", "Blocked Kick", "Penalty Flag", 
        "Holding", "False Start", "Pass Int", "Delay of Game", "Int Grounding", 
        "Roughing Passer", "Face Mask", "Timeout", "2-Min Warning", "Challenge Flag", "Measurement", 
        "Overtime", "Injury", "Coach Yelling", "Mascot", "Blimp Shot", "Face Paint", "Shirtless Fan", 
        "Truck Ad", "Beer Ad", "Helmet Throw", "Cheerleader", "Celebrity", "Hurdle", "Juke", "One-Handed Catch"
    ];

    const WINS = [
        [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], 
        [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], 
        [0,6,12,18,24], [4,8,12,16,20]
    ];

    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC = 'nfl_beano_v5';
    
    // STATE
    let client, myId = 'u' + Math.random().toString(36).substr(2,6);
    let myName="", myTeam="None", roomCode="", isHost=false;
    let gameState = { players: {} };

    // POPULATE SELECTS
    const tSelect = document.getElementById('team-select');
    const iSelect = document.getElementById('ingame-team');
    for(let t in TEAMS) {
        if(t!=="None") {
            tSelect.innerHTML += `<option value="${t}">${t}</option>`;
            iSelect.innerHTML += `<option value="${t}">${t}</option>`;
        }
    }

    // =================================================================
    // 2. LOGIC
    // =================================================================
    function createGame() {
        initPlayer(true);
        const count = parseInt(document.getElementById('card-count').value);
        // HOST creates themselves immediately
        gameState.players[myId] = generatePlayer(myName, myTeam, count);
        
        enterGame();
        connect();
    }

    function joinGame() {
        roomCode = document.getElementById('room-code').value.trim().toUpperCase();
        if(roomCode.length !== 4) return alert("Please enter a 4-letter Room Code");
        initPlayer(false);
        
        // GUEST DOES NOT create themselves yet. Wait for Host.
        enterGame();
        connect();
    }

    function initPlayer(host) {
        myName = document.getElementById('username').value.trim() || (host?"HOST":"GUEST");
        myTeam = document.getElementById('team-select').value;
        isHost = host;
        if(host) roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        
        // Update In-Game UI
        document.getElementById('ingame-team').value = myTeam;
        applyTheme(myTeam);
    }

    function enterGame() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('room-display').textContent = `ROOM: ${roomCode}`;
        if(isHost) document.getElementById('reset-btn').style.display = 'block';
        render();
    }

    function applyTheme(team) {
        const colors = TEAMS[team] || TEAMS["None"];
        const pane = document.getElementById('pane-my-hand');
        pane.style.setProperty('--my-bg', colors.p);
        pane.style.backgroundColor = colors.p; // Force update
    }

    function updateTeam() {
        myTeam = document.getElementById('ingame-team').value;
        applyTheme(myTeam);
        if(gameState.players[myId]) {
            gameState.players[myId].team = myTeam;
            render();
            send({ type: 'UPDATE_TEAM', team: myTeam });
        }
    }

    function generatePlayer(name, team, count) {
        let p = { name, team, cards: [] };
        for(let i=0; i<count; i++) p.cards.push(createCardData());
        return p;
    }

    function createCardData() {
        let deck = [...EVENTS].sort(()=>Math.random()-0.5).slice(0,24);
        deck.splice(12,0,"FREE");
        return { events: deck, marked: [12], winLine: [], rerolls: 2 };
    }

    // =================================================================
    // 3. RENDER
    // =================================================================
    function render() {
        const myArea = document.getElementById('my-area');
        const fieldArea = document.getElementById('field-area');
        myArea.innerHTML = '';
        fieldArea.innerHTML = '';

        // RENDER ME
        if(gameState.players[myId]) {
            renderPlayer(gameState.players[myId], true, myArea);
        } else {
            myArea.innerHTML = '<h2 style="opacity:0.5;">CONNECTING TO HOST...</h2>';
        }

        // RENDER FIELD
        const others = Object.keys(gameState.players).filter(id => id !== myId);
        if(others.length === 0) {
            fieldArea.innerHTML = '<div style="opacity:0.5; margin-top:50px;">WAITING FOR PLAYERS...</div>';
        } else {
            others.forEach(pid => renderPlayer(gameState.players[pid], false, fieldArea));
        }
    }

    function renderPlayer(p, isMe, container) {
        const wrap = document.createElement('div');
        wrap.className = isMe ? 'player-block me' : 'player-block';
        const colors = TEAMS[p.team] || TEAMS["None"];

        // Header
        const head = document.createElement('div');
        head.className = 'player-header';
        
        // Try loading logo
        const logo = document.createElement('img');
        logo.className = 'team-logo';
        logo.src = `logos/${p.team}.svg`;
        logo.onerror = function(){ this.style.display='none'; };
        if(p.team!=="None") head.appendChild(logo);

        const name = document.createElement('div');
        name.className = 'player-name';
        name.innerHTML = p.name;
        if(p.cards.some(c => c.winLine.length>0)) {
            name.innerHTML += " ðŸ†";
            name.style.color = "#fbbf24";
        } else {
            name.style.color = isMe ? "white" : "#cbd5e1";
        }
        head.appendChild(name);
        wrap.appendChild(head);

        // Cards Row
        const row = document.createElement('div');
        row.className = 'cards-row';

        p.cards.forEach((c, cIdx) => {
            const cWrap = document.createElement('div');
            cWrap.className = 'bingo-card-wrap';

            const card = document.createElement('div');
            card.className = 'bingo-card';

            // Card Header
            const cTop = document.createElement('div');
            cTop.className = 'card-top';
            cTop.textContent = `CARD ${cIdx+1}`;
            cTop.style.backgroundColor = (c.winLine.length>0) ? '#fbbf24' : (isMe ? 'rgba(0,0,0,0.4)' : colors.p);
            if(c.winLine.length>0) cTop.style.color = 'black';
            card.appendChild(cTop);

            // Grid
            const grid = document.createElement('div');
            grid.className = 'grid';

            c.events.forEach((evt, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = evt;

                if(idx === 12) {
                    cell.classList.add('free');
                    cell.style.backgroundColor = colors.p;
                }
                if(c.marked.includes(idx)) cell.classList.add('marked');
                if(c.winLine.includes(idx)) cell.classList.add('winning-line');

                if(isMe) {
                    cell.onclick = () => {
                        if(idx===12) return;
                        if(c.marked.includes(idx)) c.marked = c.marked.filter(x=>x!==idx);
                        else c.marked.push(idx);
                        checkWin(c);
                        render();
                        send({type:'UPDATE', pData:p});
                    }
                }
                grid.appendChild(cell);
            });
            card.appendChild(grid);
            cWrap.appendChild(card);

            // Reroll UI
            if(isMe) {
                const bar = document.createElement('div');
                bar.className = 'reroll-bar';
                
                const info = document.createElement('span');
                info.className = 'reroll-info';
                info.textContent = `${c.rerolls} Rerolls Left`;
                
                const btn = document.createElement('button');
                btn.className = 'reroll-btn';
                btn.textContent = c.rerolls > 0 ? "REROLL" : "STUCK";
                btn.disabled = c.rerolls <= 0;
                btn.onclick = () => {
                    if(confirm("Reroll this card? (Marks will be cleared)")) {
                        c.rerolls--;
                        let newC = createCardData();
                        c.events = newC.events;
                        c.marked = [12];
                        c.winLine = [];
                        render();
                        send({type:'UPDATE', pData:p});
                    }
                };

                bar.appendChild(info);
                bar.appendChild(btn);
                cWrap.appendChild(bar);
            }

            row.appendChild(cWrap);
        });

        wrap.appendChild(row);
        container.appendChild(wrap);
    }

    function checkWin(c) {
        for(let l of WINS) {
            if(l.every(i => c.marked.includes(i))) {
                c.winLine = l;
                celebrate();
                return;
            }
        }
        c.winLine = [];
    }

    // =================================================================
    // 4. NETWORK
    // =================================================================
    function connect() {
        client = mqtt.connect(BROKER);
        const topic = `${TOPIC}/${roomCode}`;

        client.on('connect', () => {
            client.subscribe(topic);
            if(isHost) setInterval(() => send({ type: 'STATE', state: gameState }), 1000);
            else {
                const count = parseInt(document.getElementById('card-count').value);
                let iv = setInterval(() => {
                    if(gameState.players[myId]) clearInterval(iv);
                    else send({ type: 'JOIN', name: myName, team: myTeam, count: count });
                }, 1500);
            }
        });

        client.on('message', (t, m) => {
            const msg = JSON.parse(m.toString());
            if(msg.sender === myId) return;

            if(isHost) {
                if(msg.type === 'JOIN' && !gameState.players[msg.sender]) {
                    gameState.players[msg.sender] = generatePlayer(msg.name, msg.team, msg.count);
                    render();
                }
                if(msg.type === 'UPDATE') {
                    gameState.players[msg.sender] = msg.pData;
                    if(msg.pData.cards.some(c => c.winLine.length>0)) celebrate();
                    render();
                }
                if(msg.type === 'UPDATE_TEAM') {
                    if(gameState.players[msg.sender]) {
                        gameState.players[msg.sender].team = msg.team;
                        render();
                    }
                }
            } else {
                if(msg.type === 'STATE') {
                    let local = gameState.players[myId];
                    gameState = msg.state;
                    if(local) gameState.players[myId] = local;
                    
                    // Global celebration check
                    if(Object.values(gameState.players).some(p=>p.cards.some(c=>c.winLine.length>0)) && !window.hasCeleb) {
                        celebrate(); window.hasCeleb=true;
                    }
                    render();
                }
            }
        });
    }

    function send(p) { p.sender=myId; client.publish(`${TOPIC}/${roomCode}`, JSON.stringify(p)); }

    function resetGame() {
        if(confirm("Reset all players?")) {
            Object.keys(gameState.players).forEach(id => {
                let p = gameState.players[id];
                gameState.players[id] = generatePlayer(p.name, p.team, p.cards.length);
            });
            window.hasCeleb = false;
            render();
        }
    }

    function celebrate() {
        const b = document.getElementById('celebration');
        for(let i=0; i<15; i++){
            let f = document.createElement('div'); f.className='football'; f.innerHTML='ðŸˆ';
            f.style.left='-100px'; f.style.top=Math.random()*80+'vh';
            f.style.animationDuration=(Math.random()*2+2)+'s';
            b.appendChild(f); setTimeout(()=>f.remove(), 4000);
        }
    }
</script>
</body>
</html>
