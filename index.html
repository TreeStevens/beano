<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFL BEANO v3.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1e293b;
            --secondary: #0f172a;
            --accent: #fff;
            --gold: #fbbf24;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background: radial-gradient(circle at center, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            min-height: 100vh;
            transition: background 0.5s ease;
            overflow-x: hidden;
        }

        /* Texture Overlay for "Field" look */
        body::before {
            content: "";
            position: fixed; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
        }

        h1, h2, h3 { font-family: 'Teko', sans-serif; text-transform: uppercase; margin: 0; letter-spacing: 1px; }

        /* --- LOBBY --- */
        #lobby {
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
        }
        .lobby-card {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 40px;
            border-radius: 20px;
            width: 100%; max-width: 450px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .lobby-card h1 { font-size: 4rem; line-height: 1; margin-bottom: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .tagline { color: #94a3b8; font-size: 0.9rem; margin-bottom: 30px; display: block; font-weight: bold; letter-spacing: 2px; }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 0.85rem; color: #cbd5e1; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        input, select {
            width: 100%; padding: 15px;
            background: rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.3);
            color: white; border-radius: 8px; font-size: 1.1rem;
            outline: none; transition: 0.2s;
        }
        input:focus, select:focus { border-color: white; background: rgba(0,0,0,0.8); }

        .flex-row { display: flex; gap: 10px; }
        .flex-row > div { flex: 1; }

        button {
            width: 100%; padding: 16px; font-size: 1.5rem; font-family: 'Teko', sans-serif;
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
            margin-top: 10px; text-transform: uppercase; font-weight: 600;
        }
        button:active { transform: scale(0.98); }
        
        .btn-host { background: white; color: black; }
        .btn-host:hover { background: #e2e8f0; }
        
        .btn-join { 
            background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; 
        }
        .btn-join:hover { border-color: white; background: rgba(255,255,255,0.1); }

        .divider { display: flex; align-items: center; margin: 25px 0; color: #64748b; font-size: 0.9rem; font-weight: bold; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
        .divider span { padding: 0 10px; }

        /* --- GAME HEADER --- */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .room-code-display { font-family: monospace; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; margin-left: 10px; color: #fbbf24; }

        /* --- GAME BOARD --- */
        .game-board { padding: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }

        .section-header {
            font-size: 2rem; color: rgba(255,255,255,0.9);
            margin: 30px 0 15px 0;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            border-bottom: 2px solid rgba(255,255,255,0.2);
            display: inline-block;
        }

        /* --- PLAYER BLOCKS --- */
        .player-container {
            display: flex; 
            flex-wrap: wrap; 
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
        }

        .player-block {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            position: relative;
            transition: transform 0.3s;
        }

        .player-info {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 5px;
        }
        
        .player-name {
            font-family: 'Teko'; font-size: 2rem; line-height: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        /* --- CARD LAYOUT (SIDE BY SIDE) --- */
        .cards-row {
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            justify-content: center;
        }

        .bingo-card {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            width: 100%;
            /* Responsive Sizing */
            min-width: 300px;
            max-width: 340px;
            flex: 1 1 300px; 
            border: 1px solid #333;
        }

        .card-header {
            padding: 8px; text-align: center; 
            font-weight: 900; font-size: 1rem;
            text-transform: uppercase; letter-spacing: 1px;
            color: white;
        }

        .grid {
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 1px; 
            background: #222; 
            border-top: 1px solid #222;
            aspect-ratio: 1/1;
        }

        .cell {
            background: #f1f5f9;
            display: flex; align-items: center; justify-content: center;
            text-align: center; 
            font-size: 11px; 
            padding: 4px;
            color: #0f172a; 
            user-select: none; 
            cursor: default;
            line-height: 1.1; 
            font-weight: 700;
            word-break: normal; overflow-wrap: break-word;
        }

        /* My Cards Interactive */
        .is-me .cell { cursor: pointer; transition: background 0.1s; }
        .is-me .cell:hover { background: #e2e8f0; }

        /* States */
        .cell.marked { 
            background-color: #15803d !important; 
            color: white !important; 
            position: relative;
        }
        .cell.marked::after {
            content: "‚úï"; position: absolute; 
            opacity: 0.3; font-size: 20px;
        }

        .cell.free { 
            background: #334155 !important; 
            color: white !important; 
            font-weight: 900; font-size: 10px;
            border: none;
        }

        /* WINNER STYLES */
        .player-block.winner {
            border: 3px solid var(--gold);
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.4);
            animation: pop 0.5s ease;
        }
        @keyframes pop { 0% { transform: scale(0.95); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .cell.winning-line { 
            background: var(--gold) !important; 
            color: black !important; 
            z-index: 2;
        }

        /* BOTTOM CONTROLS */
        .controls-bar {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.9); padding: 15px;
            display: flex; justify-content: center; gap: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 200;
        }
        .btn-control {
            width: auto; margin: 0; padding: 8px 20px; font-size: 1.1rem;
            background: #334155; color: white;
        }

        /* FOOTBALLS */
        #celebration { position: fixed; inset: 0; pointer-events: none; z-index: 3000; overflow: hidden; }
        .football { position: absolute; font-size: 4rem; animation: spinFly 3s linear infinite; }
        @keyframes spinFly { 
            from { transform: translate(-100px, 100vh) rotate(0deg); } 
            to { transform: translate(120vw, -200px) rotate(720deg); } 
        }

        .hidden { display: none !important; }

        /* Mobile Tweak */
        @media (max-width: 600px) {
            .bingo-card { min-width: 100%; max-width: 100%; }
            .lobby-card h1 { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby">
        <div class="lobby-card">
            <h1>NFL BEANO</h1>
            <span class="tagline">v3.0 | Game Day Edition</span>

            <!-- User Info -->
            <div class="input-group">
                <label>Player Name</label>
                <input type="text" id="username" placeholder="e.g. Switch" maxlength="12">
            </div>

            <div class="flex-row">
                <div class="input-group">
                    <label>Your Team</label>
                    <select id="lobby-team-select" onchange="updateLobbyTheme()">
                        <option value="None">Neutral</option>
                        <!-- Teams JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label>Card Count</label>
                    <select id="lobby-count">
                        <option value="1">1 Card</option>
                        <option value="2">2 Cards</option>
                        <option value="3">3 Cards</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <button class="btn-host" onclick="createGame()">CREATE NEW ROOM</button>
            
            <div class="divider"><span>OR JOIN</span></div>

            <div class="flex-row">
                <div class="input-group" style="flex:2;">
                    <input type="text" id="room-code-input" placeholder="CODE" maxlength="4" style="text-transform:uppercase; text-align:center; letter-spacing:3px; font-family:monospace; font-weight:bold;">
                </div>
                <div style="flex:1;">
                    <button class="btn-join" style="margin:0; height:100%;" onclick="joinGame()">GO</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME -->
    <div id="game-ui" class="hidden">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <h2>BEANO</h2>
                <span class="room-code-display" id="room-display">----</span>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.8rem; color:#aaa;">STYLE:</span>
                <select id="game-team-select" onchange="changeMyTheme()" style="padding:5px; width:auto; font-size:0.9rem;">
                    <!-- Teams JS -->
                </select>
            </div>
        </div>

        <div class="game-board">
            <!-- My Section -->
            <div class="section-header">MY HAND</div>
            <div id="my-area" class="player-container"></div>

            <!-- Others Section -->
            <div class="section-header" style="margin-top: 50px;">THE FIELD</div>
            <div id="field-area" class="player-container">
                <div style="color:rgba(255,255,255,0.5); width:100%; text-align:center;">Waiting for players...</div>
            </div>
        </div>

        <!-- Host Footer -->
        <div id="host-controls" class="controls-bar hidden">
            <button class="btn-control" style="background:#ef4444;" onclick="resetGame()">‚ö† NEW CARDS FOR ALL</button>
        </div>
    </div>

    <div id="celebration"></div>

<script>
    // =================================================================
    // 1. CONFIG & DATA
    // =================================================================
    const TEAMS = {
        "None": { p: "#1e293b", s: "#0f172a" }, 
        "ARI": { p: "#97233F", s: "#000000" }, "ATL": { p: "#A71930", s: "#000000" },
        "BAL": { p: "#241773", s: "#000000" }, "BUF": { p: "#00338D", s: "#C60C30" },
        "CAR": { p: "#0085CA", s: "#000000" }, "CHI": { p: "#0B162A", s: "#C83803" },
        "CIN": { p: "#FB4F14", s: "#000000" }, "CLE": { p: "#311D00", s: "#FF3C00" },
        "DAL": { p: "#003594", s: "#869397" }, "DEN": { p: "#FB4F14", s: "#002244" },
        "DET": { p: "#0076B6", s: "#B0B7BC" }, "GB":  { p: "#203731", s: "#FFB612" },
        "HOU": { p: "#03202F", s: "#A71930" }, "IND": { p: "#002C5F", s: "#A2AAAD" },
        "JAX": { p: "#006778", s: "#9F792C" }, "KC":  { p: "#E31837", s: "#FFB81C" },
        "LV":  { p: "#000000", s: "#A5ACAF" }, "LAC": { p: "#0080C6", s: "#FFC20E" },
        "LAR": { p: "#003594", s: "#FFD100" }, "MIA": { p: "#008E97", s: "#FC4C02" },
        "MIN": { p: "#4F2683", s: "#FFC62F" }, "NE":  { p: "#002244", s: "#C60C30" },
        "NO":  { p: "#D3BC8D", s: "#101820" }, "NYG": { p: "#0B2265", s: "#A71930" },
        "NYJ": { p: "#125740", s: "#FFFFFF" }, "PHI": { p: "#004C54", s: "#A5ACAF" },
        "PIT": { p: "#FFB612", s: "#101820" }, "SF":  { p: "#AA0000", s: "#B3995D" },
        "SEA": { p: "#002244", s: "#69BE28" }, "TB":  { p: "#D50A0A", s: "#34302B" },
        "TEN": { p: "#0C2340", s: "#4B92DB" }, "WAS": { p: "#5A1414", s: "#FFB612" }
    };

    const EVENTS = [
        "Touchdown", "Field Goal", "First Down", "2-Pt Conv", "QB Scramble", "4th Down Try", 
        "Pass > 20 Yds", "Run > 10 Yds", "3rd & Long", "Screen > 10", "Play Action", "QB Sneak", 
        "Hail Mary", "Empty Backfield", "Shotgun", "Trick Play", "Fake Punt", "Sack", "TFL", 
        "Pass Defended", "Tipped Pass", "Thrown Away", "Interception", "Fumble", "Turnover", 
        "Defensive TD", "Goal Line Stand", "3-and-Out", "Red Zone Stop", "Blocked Kick", "Penalty Flag", 
        "Holding", "False Start", "Pass Int", "Delay of Game", "Int Grounding", 
        "Roughing Passer", "Face Mask", "Timeout", "2-Min Warning", "Challenge Flag", "Measurement", 
        "Overtime", "Injury", "Coach Yelling", "Mascot", "Blimp Shot", "Face Paint", "Shirtless Fan", 
        "Truck Ad", "Beer Ad", "Helmet Throw", "Cheerleader", "Celebrity", "Hurdle", "Juke", "One-Handed Catch"
    ];

    const WINS = [
        [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], 
        [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], 
        [0,6,12,18,24], [4,8,12,16,20]
    ];

    // =================================================================
    // 2. STATE & INIT
    // =================================================================
    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_BASE = 'nfl_beano_v3';
    
    let client, myId = 'u'+Math.random().toString(36).substr(2,5);
    let myName="", myTeam="None", roomCode="", isHost=false;
    
    let gameState = { players: {} }; // id -> { name, team, cards: [] }

    // Populate Selects
    const lSel = document.getElementById('lobby-team-select');
    const gSel = document.getElementById('game-team-select');
    Object.keys(TEAMS).forEach(t => {
        if(t!=="None") {
            lSel.innerHTML += `<option value="${t}">${t}</option>`;
            gSel.innerHTML += `<option value="${t}">${t}</option>`;
        }
    });

    // =================================================================
    // 3. LOBBY LOGIC
    // =================================================================
    function updateLobbyTheme() {
        const t = document.getElementById('lobby-team-select').value;
        applyTheme(t);
    }

    function applyTheme(teamCode) {
        const colors = TEAMS[teamCode] || TEAMS["None"];
        document.body.style.setProperty('--primary', colors.p);
        document.body.style.setProperty('--secondary', colors.s);
    }

    function createGame() {
        setupPlayer();
        roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        isHost = true;
        
        // Host creates self immediately
        const count = parseInt(document.getElementById('lobby-count').value);
        gameState.players[myId] = generatePlayer(myName, myTeam, count);
        
        enterGame();
        connectMQTT();
    }

    function joinGame() {
        setupPlayer();
        roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
        if(roomCode.length !== 4) return alert("Invalid Room Code");
        isHost = false;
        
        enterGame();
        connectMQTT();
    }

    function setupPlayer() {
        myName = document.getElementById('username').value.trim() || (isHost?"Host":"Guest");
        myTeam = document.getElementById('lobby-team-select').value;
        document.getElementById('game-team-select').value = myTeam;
        applyTheme(myTeam);
    }

    function enterGame() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('room-display').textContent = roomCode;
        if(isHost) document.getElementById('host-controls').classList.remove('hidden');
        renderBoard();
    }

    function changeMyTheme() {
        myTeam = document.getElementById('game-team-select').value;
        applyTheme(myTeam);
        if(gameState.players[myId]) {
            gameState.players[myId].team = myTeam;
            renderBoard();
            send({ type: 'UPDATE_TEAM', team: myTeam });
        }
    }

    // =================================================================
    // 4. GAME LOGIC
    // =================================================================
    function generatePlayer(name, team, count) {
        let p = { name, team, cards: [] };
        for(let i=0; i<count; i++) {
            let deck = [...EVENTS].sort(()=>Math.random()-0.5).slice(0,24);
            deck.splice(12,0,"FREE");
            p.cards.push({ events: deck, marked: [12], winLine: [] });
        }
        return p;
    }

    function checkWin(marks) {
        for(let line of WINS) {
            if(line.every(i => marks.includes(i))) return line;
        }
        return null;
    }

    // =================================================================
    // 5. RENDERING
    // =================================================================
    function renderBoard() {
        const myDiv = document.getElementById('my-area');
        const fieldDiv = document.getElementById('field-area');
        
        myDiv.innerHTML = '';
        
        const others = Object.keys(gameState.players).filter(id => id !== myId);
        
        if(others.length > 0) fieldDiv.innerHTML = '';
        else fieldDiv.innerHTML = '<div style="color:rgba(255,255,255,0.5); width:100%; text-align:center;">Waiting for players...</div>';

        if(gameState.players[myId]) renderPlayer(gameState.players[myId], true, myDiv);
        
        others.forEach(pid => {
            renderPlayer(gameState.players[pid], false, fieldDiv);
        });
    }

    function renderPlayer(p, isMe, container) {
        const block = document.createElement('div');
        block.className = 'player-block';
        const colors = TEAMS[p.team] || TEAMS["None"];
        
        const winner = p.cards.some(c => c.winLine.length > 0);
        if(winner) block.classList.add('winner');

        // Header
        const info = document.createElement('div');
        info.className = 'player-info';
        info.innerHTML = `<div class="player-name" style="color:${colors.acc || '#fff'}">${p.name} ${winner?'üèÜ':''}</div>`;
        block.appendChild(info);

        // Cards Container (Row)
        const row = document.createElement('div');
        row.className = 'cards-row';

        p.cards.forEach((card, cIdx) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'bingo-card';
            
            // Card Header
            const chead = document.createElement('div');
            chead.className = 'card-header';
            chead.innerText = `Card ${cIdx+1}`;
            chead.style.background = winner ? 'var(--gold)' : colors.p;
            chead.style.color = winner ? 'black' : 'white';
            cardDiv.appendChild(chead);

            // Grid
            const grid = document.createElement('div');
            grid.className = 'grid';

            card.events.forEach((txt, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = txt;

                if(idx === 12) {
                    cell.classList.add('free');
                    cell.style.background = colors.p; // Free space matches team
                }
                if(card.marked.includes(idx)) cell.classList.add('marked');
                if(card.winLine.includes(idx)) cell.classList.add('winning-line');

                if(isMe) {
                    cell.onclick = () => {
                        if(idx===12) return;
                        if(card.marked.includes(idx)) card.marked = card.marked.filter(x=>x!==idx);
                        else card.marked.push(idx);
                        
                        const w = checkWin(card.marked);
                        if(w) {
                            card.winLine = w;
                            celebrate();
                        } else card.winLine = [];

                        renderBoard();
                        send({ type: 'UPDATE', pData: p });
                    }
                }
                grid.appendChild(cell);
            });
            cardDiv.appendChild(grid);
            row.appendChild(cardDiv);
        });

        block.appendChild(row);
        container.appendChild(block);
    }

    // =================================================================
    // 6. NETWORK
    // =================================================================
    function connectMQTT() {
        client = mqtt.connect(BROKER);
        const topic = `${TOPIC_BASE}/${roomCode}`;

        client.on('connect', () => {
            client.subscribe(topic);
            
            if(isHost) {
                setInterval(() => send({ type: 'STATE', state: gameState }), 1000);
            } else {
                // Guest Join Protocol
                const count = parseInt(document.getElementById('lobby-count').value);
                let iv = setInterval(() => {
                    if(gameState.players[myId]) clearInterval(iv);
                    else send({ type: 'JOIN', name: myName, team: myTeam, count: count });
                }, 2000);
            }
        });

        client.on('message', (t, m) => {
            const msg = JSON.parse(m.toString());
            if(msg.sender === myId) return;

            if(isHost) {
                if(msg.type === 'JOIN' && !gameState.players[msg.sender]) {
                    gameState.players[msg.sender] = generatePlayer(msg.name, msg.team, msg.count || 1);
                    renderBoard();
                }
                if(msg.type === 'UPDATE') {
                    gameState.players[msg.sender] = msg.pData;
                    if(msg.pData.cards.some(c => c.winLine.length>0)) celebrate();
                    renderBoard();
                }
                if(msg.type === 'UPDATE_TEAM') {
                    if(gameState.players[msg.sender]) {
                        gameState.players[msg.sender].team = msg.team;
                        renderBoard();
                    }
                }
            } else {
                if(msg.type === 'STATE') {
                    const myLocal = gameState.players[myId];
                    gameState = msg.state;
                    if(myLocal) gameState.players[myId] = myLocal; // Preserve local state
                    
                    // Check celebration
                    if(Object.values(gameState.players).some(p => p.cards.some(c => c.winLine.length>0)) && !window.hasCeleb) {
                        celebrate();
                        window.hasCeleb = true;
                    }
                    renderBoard();
                }
            }
        });
    }

    function send(payload) {
        payload.sender = myId;
        client.publish(`${TOPIC_BASE}/${roomCode}`, JSON.stringify(payload));
    }

    // =================================================================
    // 7. EXTRAS
    // =================================================================
    function resetGame() {
        if(confirm("Generate new cards for everyone?")) {
            Object.keys(gameState.players).forEach(pid => {
                const p = gameState.players[pid];
                gameState.players[pid] = generatePlayer(p.name, p.team, p.cards.length);
            });
            window.hasCeleb = false;
            renderBoard();
        }
    }

    function celebrate() {
        const box = document.getElementById('celebration');
        for(let i=0; i<15; i++) {
            let f = document.createElement('div');
            f.className = 'football';
            f.innerHTML = 'üèà';
            f.style.left = "-100px";
            f.style.top = Math.random() * 80 + 'vh';
            f.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
            box.appendChild(f);
            setTimeout(()=>f.remove(), 4000);
        }
    }
</script>
</body>
</html>
