<!DOCTYPE html>
<html lang="en">
<head>
    }
        .lobby-panel {
            background: rgba(255,255,255,<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba( initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    255,255,255,0.1);
            padding: 40px<title>NFL Bingo Stadium</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt;
            border-radius: 16px;
            width: 100%;
            max-width:.min.js"></script>
    
    <style>
        :root {
            --field- 450px;
            text-align: center;
            box-shadow: 0 2light: #4b9c4b;
            --field-dark: #3a803a;0px 50px rgba(0,0,0,0.5);
        }
        .lobby-panel h1 { font-size: 3rem; margin-bottom: 20px; background: -
            --chalk: rgba(255,255,255,0.8);
            --card-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }webkit-linear-gradient(#eee, #999); -webkit-background-clip: text; -webkit-text

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-fill-color: transparent; }
        
        .input-group { margin-bottom: 20px; text: repeating-linear-gradient(
                180deg,
                var(--field-light) 0-align: left; }
        .input-group label { display: block; font-size: 0px,
                var(--field-light) 40px,
                var(--chalk) 40.9rem; color: #94a3b8; margin-bottom: 5px; font-weightpx,
                var(--chalk) 42px,
                var(--field-dark) 42: bold; }
        input, select {
            width: 100%; padding: 12px,
                var(--field-dark) 82px,
                var(--chalk) 82px,
px; background: #0f172a; border: 1px solid #33415                var(--chalk) 84px
            );
            margin: 0;
            padding: 0;
5;
            color: white; border-radius: 6px; font-size: 1rem;            color: #333;
            min-height: 100vh;
        }

 outline: none;
        }
        input:focus { border-color: var(--accent); }

        .        /* === LOBBY OVERLAY === */
        #lobby-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
btn {
            width: 100%; padding: 14px; font-size: 1.2rem; font-family: 'Teko', sans-serif; font-weight: 500;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
                        border: none; border-radius: 6px; cursor: pointer; transition: all 0.2backdrop-filter: blur(5px);
        }
        .lobby-box {
            background: white; paddings; text-transform: uppercase;
        }
        .btn-primary { background: var(--accent); color:: 30px; border-radius: 15px;
            width: 90%; max-width: #0f172a; }
        .btn-primary:hover { background: #0ea5e9 400px; text-align: center;
            box-shadow: 0 20px 5; transform: translateY(-2px); }
        
        .btn-secondary { background: transparent; border:0px rgba(0,0,0,0.5);
        }
        .lobby-box h 1px solid #475569; color: #cbd5e1; margin-top:1 { margin-top: 0; color: var(--field-dark); font-size: 2. 10px; }
        .btn-secondary:hover { border-color: white; color: white5rem; font-weight: 900; text-transform: uppercase; letter-spacing: -2px; }; }

        /* --- GAME HEADER --- */
        .header-bar {
            position: sticky; top:
        input, select { width: 100%; padding: 15px; margin: 10 0; z-index: 100;
            background: rgba(15, 23px 0; border: 2px solid #eee; border-radius: 8px; font-size, 42, 0.95);
            border-bottom: 1px solid #33: 1rem; box-sizing: border-box; }
        button { width: 1004155;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .room-tag {
            background%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font: #334155; padding: 4px 12px; border-radius: 20-size: 1.1rem; cursor: pointer; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        px;
            font-family: monospace; font-size: 1rem; color: var(--accent);
.btn-host { background: #27ae60; color: white; }
        .btn-        }
        #theme-select { width: auto; padding: 5px; font-size: join { background: #2980b9; color: white; }

        /* === MAIN GAME HEADER0.9rem; margin-left: 10px; }

        /* --- PLAY AREA --- */
        .game === */
        .scoreboard-header {
            background: rgba(0,0,0,0.9-layout { padding: 20px; max-width: 1600px; margin: 0 auto;); color: white;
            padding: 10px 20px;
            display: flex; justify-content }

        /* SECTION TITLES */
        .section-title {
            font-size: 2rem; color:: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 3px solid #f1c40f var(--accent); border-bottom: 2px solid #334155;
            padding-bottom;
        }
        .room-code { font-family: monospace; background: #333; padding: 5px; margin-bottom: 20px; display: flex; justify-content: space-between;
: 5px 10px; border-radius: 5px; font-size: 1.2rem;        }

        /* GRID LAYOUTS */
        .player-grid {
            display: grid;
             letter-spacing: 2px; color: #f1c40f; }
        
        /*grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

         === THE ARENA === */
        .arena { padding: 20px; max-width: 1400px; margin: 0 auto; }

        /* SECTION TITLES */
        .section-title {
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            font-size: 1.5rem; font-weight: 900; text-transform: uppercase;
            margin: 20px 0 10px 0; border-bottom: 2px solid white; display: inline-block;
        }

        /* CARD GRID SYSTEM */
        ./* PLAYER BLOCK (Contains N cards) */
        .player-block {
            background: #1e293b;
            border-radius: 12px;
            padding: 10px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .player-name {
            text-align: centercard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, min; font-size: 1.5rem; color: white;
            padding-bottom: 5px; border-max(300px, 1fr));
            gap: 20px;
            margin-bottom:bottom: 1px solid #334155;
        }
        .player-block. 40px;
        }

        /* CARD DESIGN */
        .bingo-card {
            background: white; border-radius: 10px; overflow: hidden;
            box-shadow: var(--is-me {
            border: 2px solid var(--accent);
            background: #0f172a;
            box-shadow: 0 0 20px rgba(56, 1card-shadow);
            transition: transform 0.2s;
            position: relative;
        }89, 248, 0.1);
        }
        
        /* BINGO CARD
        .bingo-card.opponent {
            opacity: 0.9;
            transform: scale(0.95); /* Slightly smaller visually */
        }
        
        /* CARD HEADER */
        .card-top {
            padding: 10px; color: white; font-weight: bold;
 */
        .card {
            background: white;
            border-radius: 4px;
            overflow: hidden;
        }
        .card-header {
            background: #000; color: white; font-weight: bold; font-size: 0.9rem;
            text-align: center; padding: 4px; text-transform: uppercase;
        }
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            aspect-ratio            display: flex; justify-content: space-between;
            text-transform: uppercase; font-size: : 1/1;
            background: #ccc;
            gap: 1px;
        }0.9rem;
        }
        
        /* THE BINGO GRID */
        .b-grid {
            
        .cell {
            background: #fff;
            display: flex; align-items: center;display: grid;
            grid-template-columns: repeat(5, 1fr);
            aspect- justify-content: center;
            text-align: center; font-size: 0.65remratio: 1/1;
            border-top: 2px solid #333;
            background: #; padding: 2px;
            color: #333; user-select: none; cursor: default000;
            gap: 1px; /* Creates the black lines */
        }
        .cell;
            line-height: 1.1;
            word-break: break-word;
         {
            background: #fff;
            display: flex; align-items: center; justify-content: center}

        /* INTERACTIVE CELLS (MY CARD) */
        .is-me .cell { cursor: pointer; font;
            text-align: center; font-size: 10px; padding: 2px;-size: 0.75rem; }
        .is-me .cell:hover { background:
            cursor: pointer; user-select: none;
            line-height: 1.1; font #f0f9ff; }

        /* STATES */
        .cell.free-space { background: #00-weight: 500;
            word-break: break-word;
        }
        
        /* INTERACTION STATES */
        .interactive .cell:active { background: #eee; }
        .interactive .0 !important; color: #fff !important; font-weight: bold; }
        
        /* MARKED STATEcell:hover { background: #fafafa; }
        
        /* MARKERS */
        .cell. */
        .cell.marked {
            background: #22c55e !important; /* Greenmarked { background: #2ecc71; color: #000; font-weight: bold; }
         */
            color: white !important;
            text-decoration: line-through;
        }
        
        /*.cell.free { background: #333; color: #f1c40f; font-weight:  WINNER STATE */
        .player-block.winner { animation: pulse 2s infinite; border-color: var(--900; font-size: 14px; }
        .cell.winning-cell { backgroundhighlight); }
        .player-block.winner .player-name { color: var(--highlight); }
: #f1c40f !important; color: black !important; border: 2px solid black        .player-block.winner .card-header { background: var(--highlight); color: black; }
        .cell.winning-line { background: var(--highlight) !important; color: black !important; text; }

        /* WINNER BADGE */
        .winner-badge {
            position: absolute; top: -decoration: none; font-weight: bold; }

        @keyframes pulse { 0% { box-50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-1shadow: 0 0 0 0 rgba(250, 204, 21, 00deg) scale(0);
            background: #e74c3c; color: white; padding.4); } 70% { box-shadow: 0 0 0 20px rgba: 10px 30px;
            font-size: 2rem; font-weight: 90(250, 204, 21, 0); } 100% {0; border: 5px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 10; opacity: box-shadow: 0 0 0 0 rgba(250, 204,  0; transition: 0.3s; pointer-events: none;
        }
        .has21, 0); } }

        /* CELEBRATION */
        #celebration {
            position: fixed-bingo .winner-badge { transform: translate(-50%, -50%) rotate(-10deg; inset: 0; pointer-events: none; z-index: 999;
            display: flex) scale(1); opacity: 1; }
        .has-bingo { border: 5px; justify-content: center; align-items: center;
            overflow: hidden;
        }
        .football solid #f1c40f; }

        /* === CELEBRATION === */
        #celebration--emoji { position: absolute; font-size: 4rem; animation: fly 3s linear infinite;layer {
            position: fixed; top: 0; left: 0; width: 100%; height: }
        @keyframes fly { 0% { transform: translate(-120vw, 0) rotate( 100%;
            pointer-events: none; z-index: 9999; overflow0deg); } 100% { transform: translate(120vw, 0) rotate(360deg); } }

        .hidden { display: none !important; }
    </style>: hidden; display: none;
        }
        .football { font-size: 60px; position: absolute; animation: spinFly 3s linear infinite; }
        @keyframes spinFly { 0% { transform
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby">
        <div class: translateX(-100px) rotate(0deg); } 100% { transform: translateX(="lobby-panel">
            <h1>üèà NFL BINGO</h1>
            
            <div class="input-group">
110vw) rotate(720deg); } }
        
        /* UTILS */
        .                <label>PLAYER NAME</label>
                <input type="text" id="username" placeholder="Enterhidden { display: none !important; }
        .host-only { display: none; } 
     Name...">
            </div>

            <!-- HOST CONTROLS -->
            <div id="host-opts">
                <</style>
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby-div class="input-group">
                    <label>CARDS PER PLAYER</label>
                    <select id="card-count">
                        <option value="1">1 Card</option>
                        <option value="overlay">
        <div class="lobby-box">
            <h1>üèà NFL Bingo</h1>
            <input type="text"2">2 Cards</option>
                        <option value="3">3 Cards</option>
                        <option id="username" placeholder="Enter Player Name" maxlength="12">
            
            <div style="margin value="4">4 Cards</option>
                    </select>
                </div>
                <button class="btn: 20px 0; border-top: 1px solid #eee; padding-top: 2 btn-primary" onclick="startHost()">HOST GAME</button>
            </div>

            <div style="margin0px;">
                <label style="font-weight:bold; display:block; margin-bottom:5: 20px 0; color: #475569;">‚Äî OR ‚Äî</div>

            <!-- JOIN CONTpx;">Host New Game</label>
                <select id="card-count">
                    <option value="1">ROLS -->
            <div class="input-group">
                <label>ROOM CODE</label>
1 Card Each</option>
                    <option value="2">2 Cards Each</option>
                    <option value="3                <input type="text" id="room-code" placeholder="ABCD" maxlength="4" style="text">3 Cards Each</option>
                    <option value="4">4 Cards Each</option>
                </-transform:uppercase; text-align:center; letter-spacing: 3px;">
            </div>
            select>
                <button class="btn-host" onclick="initHost()">Create Room</button>
            </div>

<button class="btn btn-secondary" onclick="startJoin()">JOIN GAME</button>
        </div>
                <div style="margin: 20px 0; border-top: 1px solid #eee</div>

    <!-- GAME SCREEN -->
    <div id="game" class="hidden">
        <div class="header-bar">
            <div style="display:flex; align-items:center; gap:1; padding-top: 20px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Join Existing</label>
                <input type="text" id="0px;">
                <h2 style="color:white;">GAME DAY</h2>
                <span class="room-tag"room-code" placeholder="Room Code (e.g. XYZA)" style="text-transform: uppercase; text-align id="room-disp">----</span>
            </div>
            <div style="display:flex; align-items:: center; letter-spacing: 3px;">
                <button class="btn-join" onclick="initJoin()">Joincenter;">
                <label style="font-size:0.8rem; color:#94a3b8; margin Game</button>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="-right:5px;">TEAM:</label>
                <select id="theme-select" onchange="changeTeam()">
game-ui" class="hidden">
        <div class="scoreboard-header">
            <div style="display:flex                    <!-- Teams via JS -->
                </select>
            </div>
        </div>

        <div class="game; gap:10px; align-items:center;">
                <span class="room-code" id="display-layout">
            
            <!-- 1. MY HAND -->
            <div class="section-title">
-code">----</span>
                <span style="font-size:0.8rem; opacity:0.                <span>MY HAND</span>
                <span id="my-status" style="font-size:1rem; color:8;">players: <span id="player-count">1</span></span>
            </div>
            
            <!-- Host Controlswhite;">Playing as: <b id="my-name-disp">...</b></span>
            </div>
            < -->
            <div id="host-controls" class="host-only" style="display:flex; gap:div id="my-area" class="player-grid">
                <!-- My cards go here -->
            </div>5px;">
                <select id="team-select" onchange="changeTeam()" style="padding:5px

            <!-- 2. THE FIELD (EVERYONE ELSE) -->
            <div class="section-title">
                ; width:auto; margin:0;">
                    <option value="None">Pick Team Color</option>
<span>THE FIELD</span>
                <span style="font-size:1rem; color:#94a3b8;">Live                    <!-- Filled by JS -->
                </select>
                <button onclick="resetGame()" style="padding:5px  View</span>
            </div>
            <div id="field-area" class="player-grid">
                <!--10px; width:auto; margin:0; font-size:0.8rem; background:#c Other players go here -->
            </div>

        </div>
    </div>

    <div id="celebration"></div>

<0392b; color:white;">Reset</button>
            </div>
        </div>

        <divscript>
    // ==================================================================
    // 1. CONSTANTS & DATA
    // ================= class="arena">
            <!-- MY CARDS -->
            <div class="section-title">My Playbook</div>
=================================================
    const TEAMS = {
        "None": "#1e293b", "ARI            <div id="my-cards-area" class="card-grid"></div>

            <!-- OPPONENT CARDS": "#97233F", "ATL": "#A71930", "BAL": "# -->
            <div class="section-title">The Field (Opponents)</div>
            <div id="241773", 
        "BUF": "#00338D", "CAR":opponent-cards-area" class="card-grid">
                <p style="color:rgba(255 "#0085CA", "CHI": "#0B162A", "CIN": "#FB4,255,255,0.7); font-style:italic;">Waiting for players...</p>
            F14", 
        "CLE": "#311D00", "DAL": "#04</div>
        </div>
    </div>

    <!-- EFFECTS -->
    <div id="celebration-layer"></div>

<1E42", "DEN": "#FB4F14", "DET": "#0076Bscript>
    // =================================================================
    // 1. DATA
    // =================================================================
6", 
        "GB": "#203731", "HOU": "#032    const EVENT_DATA = [
        "Touchdown", "Field Goal", "First Down", "2-Pt02F", "IND": "#002C5F", "JAX": "#0067 Conv", "QB Scramble", "4th Down Try", 
        "Pass > 20 Yds78", 
        "KC": "#E31837", "LV": "#000", "Run > 10 Yds", "3rd & Long", "Screen > 10", "Play Action",000", "LAC": "#0080C6", "LAR": "#00359 "QB Sneak", 
        "Hail Mary", "Empty Backfield", "Shotgun", "Trick Play4", 
        "MIA": "#008E97", "MIN": "#4F2", "Fake Punt", "Sack", "TFL", 
        "Pass Defended", "Tipped683", "NE": "#002244", "NO": "#D3BC8D Pass", "Thrown Away", "Interception", "Fumble", "Turnover on Downs", 
        "", 
        "NYG": "#0B2265", "NYJ": "#125Defensive TD", "Goal Line Stand", "3-and-Out", "Red Zone Stop", "Blocked Kick740", "PHI": "#004C54", "PIT": "#FFB612", "Penalty Flag", 
        "Holding", "False Start", "Pass Interference", "Delay of Game",", 
        "SF": "#AA0000", "SEA": "#002244 "Intentional Grounding", 
        "Roughing Passer", "Face Mask", "Timeout", "2-", "TB": "#D50A0A", "TEN": "#0C2340", Min Warning", "Challenge Flag", "Measurement", 
        "Overtime", "Injury", "Coach Yelling
        "WAS": "#5A1414"
    };

    const EVENTS = [
        ", "Mascot", "Blimp Shot", "Face Paint", "Shirtless Fan", 
        ""Touchdown", "Field Goal", "First Down", "2-Pt Conv", "QB Scramble", "Truck Ad", "Beer Ad", "Helmet Throw", "Cheerleader", "Celebrity", "Hurdle4th Down Try", 
        "Pass > 20 Yds", "Run > 10 Y", "Juke", "One-Handed Catch"
    ];

    const TEAM_COLORS = {
ds", "3rd & Long", "Screen > 10", "Play Action", "QB Sneak",        "None": "#333333", "ARI": "#97233F", "ATL 
        "Hail Mary", "Empty Backfield", "Shotgun", "Trick Play", "Fake Punt",": "#A71930", "BAL": "#241773", "BUF": "# "Sack", "TFL", 
        "Pass Defended", "Tipped Pass", "Thrown Away00338D", 
        "CAR": "#0085CA", "CHI": "#", "Interception", "Fumble", "Turnover on Downs", 
        "Defensive TD", "0B162A", "CIN": "#FB4F14", "CLE": "#311Goal Line Stand", "3-and-Out", "Red Zone Stop", "Blocked Kick", "Penalty Flag",D00", "DAL": "#041E42", 
        "DEN": "#FB4 
        "Holding", "False Start", "Pass Interference", "Delay of Game", "Intentional GroundingF14", "DET": "#0076B6", "GB": "#20373", 
        "Roughing Passer", "Face Mask", "Timeout", "2-Min Warning", "Challenge1", "HOU": "#03202F", "IND": "#002C5F Flag", "Measurement", 
        "Overtime", "Injury", "Coach Yelling", "Mascot", 
        "JAX": "#006778", "KC": "#E318", "Blimp Shot", "Face Paint", "Shirtless Fan", 
        "Truck Ad", "Beer37", "LV": "#000000", "LAC": "#0080C6 Ad", "Helmet Throw", "Cheerleader", "Celebrity", "Hurdle", "Juke", "One-Handed Catch"
    ];

    const WINS = [
        [0,1,", "LAR": "#003594", 
        "MIA": "#008E97", "MIN": "#4F2683", "NE": "#0022442,3,4], [5,6,7,8,9], [10,11,", "NO": "#D3BC8D", "NYG": "#0B2265", 12,13,14], [15,16,17,18,19
        "NYJ": "#125740", "PHI": "#004C54], [20,21,22,23,24], 
        [0,5", "PIT": "#FFB612", "SF": "#AA0000", "SEA":,10,15,20], [1,6,11,16,21], "#002244", 
        "TB": "#D50A0A", "TEN [2,7,12,17,22], [3,8,13,18": "#0C2340", "WAS": "#5A1414"
    };

,23], [4,9,14,19,24], 
        [0,    const WIN_LINES = [
        [0,1,2,3,4], [5,6,7,6,12,18,24], [4,8,12,16,208,9], [10,11,12,13,14], [15,]
    ];

    const MQTT_HOST = 'wss://broker.emqx.io:8084/16,17,18,19], [20,21,22,23mqtt';
    const APP_ID = 'nfl_gameday_v1';

    // =================,24], 
        [0,5,10,15,20], [1,6=================================================
    // 2. STATE
    // ==================================================================
    let client,11,16,21], [2,7,12,17,22],;
    let myId = 'u_' + Math.random().toString(36).substr(2, 6);
    let myName = "Player";
    let roomCode = "";
    let isHost [3,8,13,18,23], [4,9,14,19 = false;
    let activeTheme = "None";

    // Global State: Everyone has FULL copy
    let gameState =,24], 
        [0,6,12,18,24], [4, {
        players: {} // { [id]: { name, cards: [ { events:[], marked:[],8,12,16,20]
    ];

    // =================================================================
     winLine:[] } ] } }
    };

    // Populate Team Select
    const ts = document.getElementById// 2. STATE
    // =================================================================
    const BROKER = 'wss://broker.emqx('theme-select');
    for(let t in TEAMS) {
        let opt = document.createElement.io:8084/mqtt';
    const APP_ID = 'nfl_stadium_('option');
        opt.value = t; opt.textContent = t;
        ts.appendChild(opt);
    }

    // ==================================================================
    // 3. STARTUP LOGIC
v1';
    
    let client;
    let myId = 'u_' + Math.random().    // ==================================================================

    function startHost() {
        myName = document.getElementById('username').toString(36).substr(2,6);
    let myName = "Player";
    let roomCode =value.trim() || "Host";
        const count = parseInt(document.getElementById('card-count').value "";
    let isHost = false;
    let currentTheme = "#333333"; // Default);
        roomCode = Math.random().toString(36).substr(2, 4).toUpperCase(); black

    // The Truth (Whole Board)
    let gameState = {
        players: {} // { id:
        isHost = true;

        // Generate MY cards locally immediately
        gameState.players[myId] = createPlayer(myName, count);

        enterGame();
        connectNetwork();
    }

    function startJoin() {
        myName = document.getElementById('username').value.trim() || "Guest";
        roomCode = document. { name, cards: [ { events, marked, bingo, winIndices } ] } }
    };

    // =================getElementById('room-code').value.trim().toUpperCase();
        if (roomCode.length !== 4)================================================
    // 3. STARTUP
    // =================================================================
    
    // Fill Team return alert("Invalid Code");
        isHost = false;

        enterGame();
        connectNetwork();
    }

    function enterGame() {
        document.getElementById('lobby').classList.add('hidden');
 Select
    const ts = document.getElementById('team-select');
    for(let t in TEAM_COLORS)        document.getElementById('game').classList.remove('hidden');
        document.getElementById('room-disp').textContent { if(t!=="None") {
        let o = document.createElement('option'); o.value=t; = roomCode;
        document.getElementById('my-name-disp').textContent = myName;
        render o.textContent=t; ts.appendChild(o);
    }}

    function initHost() {
        ();
    }

    function createPlayer(name, count) {
        let p = { name: name, cardsmyName = document.getElementById('username').value.trim() || "Host";
        const count = parseInt(document: [] };
        for(let i=0; i<count; i++) {
            let evts.getElementById('card-count').value);
        roomCode = Math.random().toString(36).substr = [...EVENTS].sort(()=>Math.random()-0.5).slice(0,24);
            evts.(2,4).toUpperCase();
        isHost = true;
        
        // Setup Host State
        gameStatesplice(12,0,"FREE"); // Free Space
            p.cards.push({ events: evts,.players[myId] = createPlayer(myName, count);
        
        launchGame();
        connect marked: [12], winLine: [] });
        }
        return p;
    }

    // ==================================================================
    // 4. NETWORK (SYNC ALL)
    // =================================Net();
    }

    function initJoin() {
        myName = document.getElementById('username').value.trim=================================

    function connectNetwork() {
        client = mqtt.connect(MQTT_HOST);
        () || "Guest";
        roomCode = document.getElementById('room-code').value.trim().toUpperCase();const topic = `${APP_ID}/${roomCode}`;

        client.on('connect', () => {
            
        if(roomCode.length !== 4) return alert("Bad Room Code");
        isHost = falseclient.subscribe(topic);
            
            if (isHost) {
                // Host broadcasts State constantly
                setInterval(() => {
                    broadcast({ type: 'STATE', state: gameState, theme: activeTheme });
;

        launchGame();
        connectNet();
    }

    function launchGame() {
        document.getElementById                }, 1000);
            } else {
                // Guest asks to join
                const loop('lobby-overlay').classList.add('hidden');
        document.getElementById('game-ui').classList.remove = setInterval(() => {
                    if (gameState.players[myId]) clearInterval(loop);
                    else broadcast('hidden');
        document.getElementById('display-code').textContent = roomCode;
        if(isHost({ type: 'JOIN', name: myName });
                }, 1500);
            }
) document.getElementById('host-controls').style.display = 'flex';
        
        // Initial Render (Empty        });

        client.on('message', (t, m) => {
            const data = JSON. for Guest, Full for Host)
        renderBoard(); 
    }

    function createPlayer(name, countparse(m.toString());
            if (data.sender === myId) return;

            if (isHost)) {
        let p = { name: name, cards: [] };
        for(let i=0; {
                // HOST LOGIC: Add players, Merge clicks
                if (data.type === 'JOIN') i<count; i++) {
            let evts = [...EVENT_DATA].sort(() => Math.random()- {
                    if (!gameState.players[data.sender]) {
                        gameState.players[data.sender]0.5).slice(0,24);
            evts.splice(12, 0, "FREE SPACE");
            p.cards.push({ events: evts, marked: [12], bingo = createPlayer(data.name, gameState.players[myId].cards.length);
                        render(); // Host: false, winIndices: [] });
        }
        return p;
    }

    // ================= sees new player immediately
                    }
                }
                if (data.type === 'CLICK') {
                    ================================================
    // 4. RENDERING (THE MAGIC)
    // =================================================================
    
// Apply click to master state
                    const p = gameState.players[data.sender];
                    if (p)    function renderBoard() {
        const myContainer = document.getElementById('my-cards-area');
        const oppContainer {
                        const c = p.cards[data.cardIdx];
                        const idx = data.cellIdx = document.getElementById('opponent-cards-area');
        
        // Clear current
        myContainer.innerHTML;
                        if (c.marked.includes(idx)) c.marked = c.marked.filter(x = '';
        const opps = Object.keys(gameState.players).filter(id => id !== myId);
        =>x!==idx);
                        else c.marked.push(idx);
                        
                        // Check Win
oppContainer.innerHTML = opps.length === 0 ? '<p style="color:white; opacity:0.7                        const win = checkWin(c.marked);
                        c.winLine = win || [];
                        
; padding:10px;">Waiting for opponents to join...</p>' : '';

        // Update Count
                                render(); // Host UI updates
                        if (win) triggerCelebration();
                    }
                }
            document.getElementById('player-count').textContent = Object.keys(gameState.players).length;

        // Loop} else {
                // GUEST LOGIC: Receive full state
                if (data.type === 'STATE Every Player
        Object.keys(gameState.players).forEach(pid => {
            const pData = gameState.') {
                    // OPTIMIZATION: Only render if something changed? 
                    // For simplicity in this singleplayers[pid];
            const isMe = (pid === myId);
            const container = isMe ? file: render everything.
                    // But to prevent jitter on my own clicks, we usually preserve local state.
                     myContainer : oppContainer;

            pData.cards.forEach((card, cIdx) => {
                // Build Card Wrapper
                const div = document.createElement('div');
                div.className = isMe ? 'bing// Here we will just overwrite and trust the Host's 1s loop + fast updates.
                    
                    // To keepo-card interactive' : 'bingo-card opponent';
                if(card.bingo) div. UI snappy, we only update IF we are not currently clicking (rare conflict)
                    // Actually, best way: MergeclassList.add('has-bingo');

                // Header
                const head = document.createElement('div');
                head.className = 'card-top';
                head.style.backgroundColor = currentTheme;
                head ONLY other players, keep MY player local until confirmed.
                    const myLocal = gameState.players[myId];
                    .innerHTML = `<span>${pData.name} #${cIdx+1}</span>`;
                
                // Grid
gameState = data.state;
                    
                    if(myLocal) gameState.players[myId] = my                const grid = document.createElement('div');
                grid.className = 'b-grid';
                
                card.events.forEach((txt, idx) => {
                    const cell = document.createElement('div');Local; // Keep my local predicted state

                    if(data.theme) {
                        activeTheme = data.theme;
                        document.getElementById('theme-select').value = activeTheme;
                    }
                    
                    render();

                    cell.className = 'cell';
                    if(idx === 12) cell.classList.add('free');
                    if(card.marked.includes(idx)) cell.classList.add('marked');
                }
            }
        });
    }

    function broadcast(msg) {
        msg.sender = myId;
        client.publish(`${APP_ID}/${roomCode}`, JSON.stringify(msg));
                    if(card.winIndices.includes(idx)) cell.classList.add('winning-cell');
                    cell.textContent = txt;

                    // CLICK LOGIC (Only if it's ME)
                    if(isMe)    }

    function checkWin(marked) {
        for(let line of WINS) {
            if {
                        cell.onclick = () => {
                            if(idx === 12) return;
                            (line.every(i => marked.includes(i))) return line;
        }
        return null;
    }

    // ==================================================================
    // 5. RENDERING
    // =================
                            // Logic
                            if(card.marked.includes(idx)) card.marked = card.marked.=================================================

    function changeTeam() {
        activeTheme = document.getElementById('theme-select').filter(x=>x!==idx);
                            else card.marked.push(idx);
                            
                            // Win Check
                            const win = checkWin(card.marked);
                            if(win) {
                                card.bingovalue;
        render(); // Local update
        if(isHost) {
            // Host loop will pick = true;
                                card.winIndices = win;
                                triggerCelebration(); 
                            } else {
                                card it up in 'broadcast'
        }
    }

    function render() {
        const myArea = document.bingo = false;
                                card.winIndices = [];
                            }
                            
                            // Force Render.getElementById('my-area');
        const fieldArea = document.getElementById('field-area');
        
 & Broadcast
                            renderBoard();
                            send({ type: 'UPDATE', pData: pData });
                                // Clear
        myArea.innerHTML = '';
        fieldArea.innerHTML = '';

        const color = TEAMS[};
                    }

                    grid.appendChild(cell);
                });

                // Winner Badge Overlay
                const badgeactiveTheme] || "#333";

        // Loop all players
        Object.keys(gameState.players = document.createElement('div');
                badge.className = 'winner-badge';
                badge.innerHTML = 'TOUCHDOWN!';
                
                div.appendChild(head);
                div.appendChild(grid);
                div.appendChild(badge);
                container.appendChild(div);
            });
        });
    }

    function checkWin(marked) {
        for(let line of WIN_LINES) {
            if(line.every).forEach(pid => {
            const p = gameState.players[pid];
            const isMe = (pid === myId);

            // Create Player Block
            const block = document.createElement('div');
            block.(i => marked.includes(i))) return line;
        }
        return null;
    }

    //className = `player-block ${isMe ? 'is-me' : ''}`;
            
            // Check if winner
            const isWinner = p.cards.some(c => c.winLine.length > 0);
            if(isWinner) block.classList.add('winner');

            // Name Header
            const nameDiv =================================================================
    // 5. NETWORKING
    // =================================================================

    function connectNet = document.createElement('div');
            nameDiv.className = 'player-name';
            nameDiv.() {
        client = mqtt.connect(BROKER);
        const topic = `${APP_ID}/${roominnerHTML = `${p.name} ${isWinner ? 'üèÜ' : ''}`;
            block.appendChild(nameCode}`;
        
        client.on('connect', () => {
            client.subscribe(topic);
            
Div);

            // Cards
            p.cards.forEach((card, cIdx) => {
                const cardDiv =            if(isHost) {
                setInterval(() => send({ type: 'STATE', state: gameState, theme: document.createElement('div');
                cardDiv.className = 'card';
                
                const header = document currentTheme }), 1000);
            } else {
                const interval = setInterval(() => {
                    if.createElement('div');
                header.className = 'card-header';
                header.style.background =(gameState.players[myId]) clearInterval(interval);
                    else send({ type: 'JOIN', name: isWinner ? '#facc15' : color;
                header.style.color = isWinner ? '#0 myName });
                }, 1500);
            }
        });

        client.on('00' : '#fff';
                header.textContent = `CARD ${cIdx+1}`;
                cardDiv.appendChildmessage', (t, m) => {
            const msg = JSON.parse(m.toString());
            if(header);

                const grid = document.createElement('div');
                grid.className = 'bingo-(msg.sender === myId) return;

            if(isHost) {
                // Host Logic
grid';

                card.events.forEach((evt, idx) => {
                    const cell = document.createElement('div');                if(msg.type === 'JOIN') {
                    if(!gameState.players[msg.sender]) {
                    cell.className = 'cell';
                    cell.textContent = evt;

                    if (idx===12) {
                        // Host creates cards for new player based on Host's config
                        // We need to know how many cards
                        cell.classList.add('free-space');
                        cell.style.background = color;
                     host has to match config
                        const hostCardCount = gameState.players[myId].cards.length;
                        gameState}
                    if (card.marked.includes(idx)) cell.classList.add('marked');
                    if.players[msg.sender] = createPlayer(msg.name, hostCardCount);
                        // Force immediate (card.winLine.includes(idx)) cell.classList.add('winning-line');

                    // Click update broadcast
                        send({ type: 'STATE', state: gameState, theme: currentTheme });
                        renderBoard(); Action (Only for Me)
                    if (isMe) {
                        cell.onclick = () => {
                            if
                    }
                }
                if(msg.type === 'UPDATE') {
                    gameState.players[(idx===12) return;
                            
                            // Local Optimistic Update
                            if(card.marked.includes(msg.sender] = msg.pData;
                    // Check if they triggered a bingo
                    if(msg.pDataidx)) card.marked = card.marked.filter(x=>x!==idx);
                            else card.marked.cards.some(c => c.bingo)) triggerCelebration();
                    renderBoard();
                }.push(idx);
                            
                            // Check win local
                            card.winLine = checkWin(card
            } else {
                // Guest Logic
                if(msg.type === 'STATE') {
                    //.marked) || [];
                            
                            render(); 

                            // Send to Host
                            broadcast({ type: ' Merge: Keep my local changes if they differ (to prevent click lag), adopt others
                    const myLocal = gameState.CLICK', cardIdx: cIdx, cellIdx: idx });
                        };
                    }

                    grid.appendChild(cell);players[myId];
                    gameState = msg.state;
                    if(myLocal) gameState.players[
                });

                cardDiv.appendChild(grid);
                block.appendChild(cardDiv);
            });myId] = myLocal; 

                    // Theme sync
                    if(msg.theme) currentTheme = msg

            // Place in correct area
            if (isMe) myArea.appendChild(block);
            else fieldArea..theme;

                    // Celebration Sync (Did anyone new win?)
                    Object.values(gameState.players).forEachappendChild(block);
        });
    }

    function triggerCelebration() {
        const box = document.getElementById(p => {
                         if(p.cards.some(c => c.bingo && !c.('celebration');
        // Create a football
        const fb = document.createElement('div');
        fb.textContentcelebrated)) {
                             triggerCelebration();
                             c.celebrated = true; // Local flag to stop infinite = 'üèà';
        fb.className = 'football-emoji';
        fb.style.top = Math celebration loop
                         }
                    });

                    renderBoard();
                }
            }
        });
    }.random() * 80 + 10 + 'vh';
        box.appendChild(fb);


    function send(payload) {
        payload.sender = myId;
        client.publish(`${APP        setTimeout(() => fb.remove(), 3000);
    }
</script>
</body>
</html>
