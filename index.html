<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFL BEANO v6.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Titan+One&display=swap" rel="stylesheet">

    <style>
        :root {
            --team-color: #333; /* Changes based on selection */
            --accent: #fff;
            --gold: #fbbf24;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Fredoka', sans-serif;
            background-color: #0f172a; 
            color: #333;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        /* --- LOBBY --- */
        #lobby {
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.9);
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .lobby-panel {
            background: white;
            padding: 40px;
            border-radius: 30px;
            width: 90%; max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 0px rgba(0,0,0,0.2);
            border: 6px solid #fff;
        }
        .lobby-panel h1 { font-family: 'Titan One', cursive; font-size: 3rem; margin: 0; color: #333; text-transform: uppercase; letter-spacing: 2px; }
        
        .input-group { margin: 20px 0; text-align: left; }
        .input-group label { display: block; font-weight: 800; color: #555; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        select, input {
            width: 100%; padding: 15px;
            border: 3px solid #eee; border-radius: 12px;
            font-size: 1.1rem; font-family: 'Fredoka', sans-serif; font-weight: 700;
            outline: none;
        }
        select:focus, input:focus { border-color: #333; }

        button {
            width: 100%; padding: 15px;
            border: none; border-radius: 15px;
            font-family: 'Titan One', cursive; font-size: 1.5rem; letter-spacing: 1px;
            cursor: pointer; transform: translateY(0); transition: 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
            margin-top: 10px;
        }
        button:active { transform: translateY(6px); box-shadow: none; }
        .btn-host { background: #ff4757; color: white; }
        .btn-join { background: #2ed573; color: white; }

        /* --- GAME AREA --- */
        #game-ui {
            padding: 40px 20px;
            min-height: 100vh;
            width: 100%;
            display: flex;
            justify-content: center; /* Center by default */
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 40px;
        }

        /* Dynamic Backgrounds */
        body.solo-mode {
            background: var(--team-color); /* Full screen single color */
            background-image: radial-gradient(circle, rgba(255,255,255,0.1) 10%, transparent 10%);
            background-size: 30px 30px;
        }

        body.multi-mode {
            /* Split / VS Background */
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        /* --- PLAYER ZONE --- */
        .player-zone {
            background-color: var(--p-primary, #333);
            border-radius: 30px;
            padding: 30px;
            width: auto;
            min-width: 350px;
            /* By default, zones are just blocks. */
            /* In solo mode, we might scale the main player up slightly */
            border: 8px solid white;
            box-shadow: 0 15px 0 rgba(0,0,0,0.25);
            position: relative;
            overflow: visible;
            transition: all 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .player-zone::before {
            content: ""; position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 5c5 0 5 10 10 10s5-10 10-10' stroke='white' stroke-width='3' fill='none' opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.3; pointer-events: none;
        }

        /* Header Pop-out */
        .zone-header {
            margin-top: -50px; /* Pop out top */
            display: flex; flex-direction: column; align-items: center;
            margin-bottom: 20px; z-index: 10;
        }

        .team-logo {
            width: 100px; height: 100px;
            background: white; border-radius: 50%;
            border: 5px solid white; object-fit: contain; padding: 5px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        .player-name {
            color: white; font-family: 'Titan One', cursive; font-size: 2rem;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.3); text-transform: uppercase;
            margin-top: 5px;
        }

        /* Cards Row */
        .cards-row {
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; z-index: 5;
        }

        .card-wrapper { width: 300px; display: flex; flex-direction: column; gap: 10px; }

        .bingo-card {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1); border: 4px solid white;
        }

        .card-title {
            background: var(--p-secondary, #555); color: white;
            text-align: center; font-weight: 900; padding: 8px;
            font-size: 1.1rem; text-transform: uppercase;
        }

        .grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 2px; background: #eee; border: 2px solid #eee;
            aspect-ratio: 1/1;
        }

        .cell {
            background: var(--p-primary, #333); /* Cells match team */
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 11px; padding: 2px;
            font-weight: 700; color: white; line-height: 1.1;
            user-select: none; border-radius: 2px;
        }
        /* Checkerboard effect */
        .cell:nth-child(odd) { filter: brightness(1.1); }

        .cell.free {
            background: white !important; color: #333 !important;
            font-size: 14px; font-weight: 900; border: 2px solid #eee;
            display: flex; flex-direction: column; line-height: 1;
        }
        .cell.free::after { content:"üèà"; font-size:16px; margin-top:2px; }

        .is-me .cell:not(.free) { cursor: pointer; }
        .is-me .cell:not(.free):active { transform: scale(0.9); }

        .cell.marked { background: #ffbf00 !important; color: black !important; }
        
        .cell.winning-line {
            background: white !important; color: black !important;
            animation: flash 1s infinite;
        }
        @keyframes flash { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }

        /* Reroll UI */
        .reroll-container {
            background: rgba(255,255,255,0.2); padding: 8px 15px;
            border-radius: 12px; display: flex; justify-content: space-between;
            align-items: center; color: white; font-weight: bold; font-size: 0.9rem;
        }
        .reroll-btn {
            background: #ff4757; color: white; border: none; padding: 6px 12px;
            border-radius: 8px; font-family: 'Titan One', cursive; font-size: 0.8rem;
            cursor: pointer; margin: 0; width: auto; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .reroll-btn:disabled { background: #555; opacity: 0.6; box-shadow: none; cursor: default; }

        /* Floating Controls */
        .float-controls {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            background: white; padding: 10px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; gap: 10px; align-items: center;
        }

        #celebration { position: fixed; inset: 0; pointer-events: none; z-index: 5000; }
        .football { position: absolute; font-size: 5rem; animation: spinFly 3s linear infinite; }
        @keyframes spinFly { from { transform: translate(-100px, 100vh) rotate(0deg); } to { transform: translate(120vw, -200px) rotate(720deg); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby">
        <div class="lobby-panel">
            <h1>NFL Beano</h1>
            
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="username" placeholder="ENTER NAME" maxlength="12">
            </div>

            <div class="input-group">
                <label>Your Team</label>
                <select id="lobby-team-select">
                    <option value="None">Select Team...</option>
                    <!-- Teams JS -->
                </select>
            </div>

            <div style="display:flex; gap:15px;">
                <div class="input-group" style="flex:1">
                    <label>Cards</label>
                    <select id="lobby-count">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
                <div class="input-group" style="flex:2">
                    <label>Room</label>
                    <input type="text" id="room-code-input" placeholder="CODE" style="text-transform: uppercase;">
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-host" onclick="startGame(true)">HOST</button>
                <button class="btn-join" onclick="startGame(false)">JOIN</button>
            </div>
        </div>
    </div>

    <!-- GAME BOARD -->
    <div id="game-ui" class="hidden"></div>

    <!-- CONTROLS -->
    <div class="float-controls hidden" id="controls">
        <div style="font-weight:bold;">ROOM: <span id="room-display"></span></div>
        <select id="ingame-team-select" onchange="changeMyTeam()" style="padding:5px; width:auto; font-size:0.8rem; border:1px solid #ccc;">
            <!-- Teams JS -->
        </select>
        <button id="host-reset-btn" onclick="resetGame()" style="background:#ff4757; color:white; font-size:0.8rem; padding:5px 10px; width:auto; display:none;">RESET</button>
    </div>

    <div id="celebration"></div>

<script>
    const TEAMS = {
        "None": { p: "#333333", s: "#555555", logo: "nfl.svg" },
        "ARI": { p: "#97233F", s: "#000000", logo: "arizona-cardinals.svg" },
        "ATL": { p: "#A71930", s: "#000000", logo: "atlanta-falcons.svg" },
        "BAL": { p: "#241773", s: "#9E7C0C", logo: "baltimore-ravens.svg" },
        "BUF": { p: "#00338D", s: "#C60C30", logo: "buffalo-bills.svg" },
        "CAR": { p: "#0085CA", s: "#000000", logo: "carolina-panthers.svg" },
        "CHI": { p: "#0B162A", s: "#C83803", logo: "chicago-bears.svg" },
        "CIN": { p: "#FB4F14", s: "#000000", logo: "cincinnati-bengals.svg" },
        "CLE": { p: "#311D00", s: "#FF3C00", logo: "cleveland-browns.svg" },
        "DAL": { p: "#003594", s: "#869397", logo: "dallas-cowboys.svg" },
        "DEN": { p: "#FB4F14", s: "#002244", logo: "denver-broncos.svg" },
        "DET": { p: "#0076B6", s: "#B0B7BC", logo: "detroit-lions.svg" },
        "GB":  { p: "#203731", s: "#FFB612", logo: "green-bay-packers.svg" },
        "HOU": { p: "#03202F", s: "#A71930", logo: "houston-texans.svg" },
        "IND": { p: "#002C5F", s: "#A2AAAD", logo: "indianapolis-colts.svg" },
        "JAX": { p: "#006778", s: "#9F792C", logo: "jacksonville-jaguars.svg" },
        "KC":  { p: "#E31837", s: "#FFB81C", logo: "kansas-city-chiefs.svg" },
        "LV":  { p: "#000000", s: "#A5ACAF", logo: "oakland-raiders.svg" },
        "LAC": { p: "#0080C6", s: "#FFC20E", logo: "los-angeles-chargers.svg" },
        "LAR": { p: "#003594", s: "#FFD100", logo: "los-angeles-rams.svg" },
        "MIA": { p: "#008E97", s: "#FC4C02", logo: "miami-dolphins.svg" },
        "MIN": { p: "#4F2683", s: "#FFC62F", logo: "minnesota-vikings.svg" },
        "NE":  { p: "#002244", s: "#C60C30", logo: "new-england-patriots.svg" },
        "NO":  { p: "#D3BC8D", s: "#101820", logo: "new-orleans-saints.svg" },
        "NYG": { p: "#0B2265", s: "#A71930", logo: "new-york-giants.svg" },
        "NYJ": { p: "#125740", s: "#FFFFFF", logo: "new-york-jets.svg" },
        "PHI": { p: "#004C54", s: "#A5ACAF", logo: "philadelphia-eagles.svg" },
        "PIT": { p: "#FFB612", s: "#101820", logo: "pittsburgh-steelers.svg" },
        "SF":  { p: "#AA0000", s: "#B3995D", logo: "san-francisco-49ers.svg" },
        "SEA": { p: "#002244", s: "#69BE28", logo: "seattle-seahawks.svg" },
        "TB":  { p: "#D50A0A", s: "#34302B", logo: "tampa-bay-buccaneers.svg" },
        "TEN": { p: "#0C2340", s: "#4B92DB", logo: "tennessee-titans.svg" },
        "WAS": { p: "#5A1414", s: "#FFB612", logo: "washington-commanders.svg" }
    };

    const EVENTS = [
        "TOUCHDOWN", "FIELD GOAL", "FIRST DOWN", "2-PT CONV", "QB SCRAMBLE", "4TH DOWN TRY", 
        "PASS > 20 YDS", "RUN > 10 YDS", "3RD & LONG", "SCREEN > 10", "PLAY ACTION", "QB SNEAK", 
        "HAIL MARY", "EMPTY BACKFIELD", "SHOTGUN", "TRICK PLAY", "FAKE PUNT", "SACK", "TFL", 
        "PASS DEFENDED", "TIPPED PASS", "THROWN AWAY", "INTERCEPTION", "FUMBLE", "TURNOVER", 
        "DEFENSIVE TD", "GOAL LINE STAND", "3-AND-OUT", "RED ZONE STOP", "BLOCKED KICK", "PENALTY FLAG", 
        "HOLDING", "FALSE START", "PASS INT", "DELAY OF GAME", "INT GROUNDING", 
        "ROUGHING PASSER", "FACE MASK", "TIMEOUT", "2-MIN WARNING", "CHALLENGE FLAG", "MEASUREMENT", 
        "OVERTIME", "INJURY", "COACH YELLING", "MASCOT", "BLIMP SHOT", "FACE PAINT", "SHIRTLESS FAN", 
        "TRUCK AD", "BEER AD", "HELMET THROW", "CHEERLEADER", "CELEBRITY", "HURDLE", "JUKE", "ONE-HANDED CATCH"
    ];

    const WINS = [
        [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], 
        [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], 
        [0,6,12,18,24], [4,8,12,16,20]
    ];

    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC = 'nfl_beano_v6';
    let client, myId='u'+Math.random().toString(36).substr(2,5), myName="", myTeam="None", roomCode="", isHost=false;
    let gameState = { players: {} };

    // INIT UI
    const ls = document.getElementById('lobby-team-select');
    const gs = document.getElementById('ingame-team-select');
    for(let t in TEAMS) {
        if(t!=="None") {
            ls.innerHTML += `<option value="${t}">${t}</option>`;
            gs.innerHTML += `<option value="${t}">${t}</option>`;
        }
    }

    function startGame(host) {
        myName = document.getElementById('username').value.trim() || (host?"HOST":"GUEST");
        myTeam = ls.value;
        const count = parseInt(document.getElementById('lobby-count').value);
        isHost = host;
        
        if(host) roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        else roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
        
        if(!roomCode) return alert("Need Code");

        if(host) {
            gameState.players[myId] = generatePlayer(myName, myTeam, count);
        }
        
        enterUI();
        connect();
    }

    function enterUI() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('controls').classList.remove('hidden');
        document.getElementById('room-display').innerText = roomCode;
        document.getElementById('ingame-team-select').value = myTeam;
        if(isHost) document.getElementById('host-reset-btn').style.display = 'block';
        
        // Force background update immediately based on player count (1 initially)
        updateBackgroundMode();
        render();
    }

    function generatePlayer(name, team, count) {
        let p = { name, team, cards: [] };
        for(let i=0; i<count; i++) p.cards.push(createCardData());
        return p;
    }

    function createCardData() {
        let deck = [...EVENTS].sort(()=>Math.random()-0.5).slice(0,24);
        deck.splice(12,0,"FREE");
        return { events: deck, marked: [12], winLine: [], rerolls: 2 };
    }

    function rerollCard(pId, cardIndex) {
        if(pId !== myId) return;
        let p = gameState.players[myId];
        let c = p.cards[cardIndex];
        if(c.rerolls > 0) {
            if(confirm("Reroll? New events will be generated.")) {
                c.rerolls--;
                let newData = createCardData();
                c.events = newData.events;
                c.marked = [12];
                c.winLine = [];
                render();
                send({ type: 'UPDATE', pData: p });
            }
        }
    }

    function changeMyTeam() {
        myTeam = document.getElementById('ingame-team-select').value;
        if(gameState.players[myId]) {
            gameState.players[myId].team = myTeam;
            updateBackgroundMode(); // Update BG if in solo mode
            render();
            send({ type: 'UPDATE_TEAM', team: myTeam });
        }
    }

    function checkWin(m) {
        for(let l of WINS) if(l.every(i=>m.includes(i))) return l;
        return null;
    }

    // Controls background style based on player count
    function updateBackgroundMode() {
        const count = Object.keys(gameState.players).length;
        const body = document.body;
        if(count <= 1) {
            body.className = 'solo-mode';
            const c = TEAMS[myTeam] ? TEAMS[myTeam].p : "#333";
            body.style.setProperty('--team-color', c);
        } else {
            body.className = 'multi-mode';
            body.style.removeProperty('--team-color');
        }
    }

    function render() {
        const board = document.getElementById('game-ui');
        board.innerHTML = '';

        // Sort so I am always first (if I exist), then others
        const pIds = Object.keys(gameState.players).sort((a,b) => {
            if(a === myId) return -1;
            if(b === myId) return 1;
            return 0;
        });

        if(pIds.length === 0) {
            board.innerHTML = '<h2 style="color:white; width:100%; text-align:center; margin-top:100px;">Connecting...</h2>';
            return;
        }

        pIds.forEach(id => {
            renderPlayerZone(gameState.players[id], id === myId, board);
        });
        
        updateBackgroundMode();
    }

    function renderPlayerZone(p, isMe, container) {
        const colors = TEAMS[p.team] || TEAMS["None"];
        
        const zone = document.createElement('div');
        zone.className = 'player-zone ' + (isMe ? 'is-me' : '');
        zone.style.setProperty('--p-primary', colors.p);
        zone.style.setProperty('--p-secondary', colors.s);
        
        if(p.cards.some(c => c.winLine.length > 0)) zone.classList.add('winner');

        // Header
        const header = document.createElement('div');
        header.className = 'zone-header';
        
        const img = document.createElement('img');
        img.className = 'team-logo';
        img.src = `logos/${colors.logo}`;
        img.onerror = function(){ this.style.display='none'; }; 
        header.appendChild(img);

        const name = document.createElement('div');
        name.className = 'player-name';
        name.innerText = p.name;
        if(p.cards.some(c=>c.winLine.length>0)) name.innerText += " üèÜ";
        header.appendChild(name);
        
        zone.appendChild(header);

        // Cards
        const row = document.createElement('div');
        row.className = 'cards-row';

        p.cards.forEach((c, cIdx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';

            const card = document.createElement('div');
            card.className = 'bingo-card';

            const title = document.createElement('div');
            title.className = 'card-title';
            title.innerText = `CARD ${cIdx+1}`;
            if(c.winLine.length>0) { title.style.background = "#ffbf00"; title.style.color = "black"; }
            card.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'grid';

            c.events.forEach((evt, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                if(idx===12) {
                    cell.classList.add('free');
                } else {
                    cell.innerText = evt;
                }

                // Interaction
                if(isMe) {
                    cell.onclick = () => {
                        if(idx===12) return;
                        if(c.marked.includes(idx)) c.marked = c.marked.filter(x=>x!==idx);
                        else c.marked.push(idx);
                        const w = checkWin(c.marked);
                        c.winLine = w || [];
                        if(w) celebrate();
                        render();
                        send({ type:'UPDATE', pData: p });
                    }
                }

                if(c.marked.includes(idx)) cell.classList.add('marked');
                if(c.winLine.includes(idx)) cell.classList.add('winning-line');
                
                grid.appendChild(cell);
            });
            card.appendChild(grid);
            wrapper.appendChild(card);

            if(isMe) {
                const rrDiv = document.createElement('div');
                rrDiv.className = 'reroll-container';
                rrDiv.innerHTML = `<span>REROLLS: ${c.rerolls}</span>`;
                const btn = document.createElement('button');
                btn.className = 'reroll-btn';
                btn.innerText = "ROLL NEW";
                btn.disabled = c.rerolls <= 0;
                btn.onclick = () => rerollCard(myId, cIdx);
                rrDiv.appendChild(btn);
                wrapper.appendChild(rrDiv);
            }

            row.appendChild(wrapper);
        });

        zone.appendChild(row);
        container.appendChild(zone);
    }

    function connect() {
        client = mqtt.connect(BROKER);
        const t = `${TOPIC}/${roomCode}`;
        client.on('connect', ()=>{
            client.subscribe(t);
            if(isHost) setInterval(()=>send({type:'STATE', state:gameState}), 1000);
            else {
                const cnt = parseInt(document.getElementById('lobby-count').value);
                let iv = setInterval(()=>{
                    if(gameState.players[myId]) clearInterval(iv);
                    else send({type:'JOIN', name:myName, team:myTeam, count:cnt});
                }, 2000);
            }
        });

        client.on('message', (topic, msg)=>{
            const m = JSON.parse(msg.toString());
            if(m.sender === myId) return;

            if(isHost) {
                if(m.type==='JOIN' && !gameState.players[m.sender]) {
                    gameState.players[m.sender] = generatePlayer(m.name, m.team, m.count);
                    render();
                }
                if(m.type==='UPDATE') {
                    gameState.players[m.sender] = m.pData;
                    if(m.pData.cards.some(c=>c.winLine.length>0)) celebrate();
                    render();
                }
                if(m.type==='UPDATE_TEAM') {
                    if(gameState.players[m.sender]) {
                        gameState.players[m.sender].team = m.team;
                        render();
                    }
                }
            } else {
                if(m.type==='STATE') {
                    let local = gameState.players[myId];
                    gameState = m.state;
                    if(local) gameState.players[myId] = local; 
                    
                    if(Object.values(gameState.players).some(p=>p.cards.some(c=>c.winLine.length>0)) && !window.hasCel) {
                        celebrate(); window.hasCel=true;
                    }
                    render();
                }
            }
        });
    }

    function send(p) { p.sender=myId; client.publish(`${TOPIC}/${roomCode}`, JSON.stringify(p)); }

    function resetGame() {
        if(confirm("Reset all cards?")) {
            Object.keys(gameState.players).forEach(id=>{
                let p = gameState.players[id];
                gameState.players[id] = generatePlayer(p.name, p.team, p.cards.length);
            });
            window.hasCel=false;
            render();
        }
    }

    function celebrate() {
        const b = document.getElementById('celebration');
        for(let i=0; i<20; i++){
            let f = document.createElement('div'); f.className='football'; f.innerHTML='üèà';
            f.style.left='-100px'; f.style.top=Math.random()*80+'vh';
            f.style.animationDuration=(Math.random()*2+2)+'s';
            b.appendChild(f); setTimeout(()=>f.remove(), 4000);
        }
    }
</script>
</body>
</html>
