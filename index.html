<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL BINGO - FIXED VERSION</title>
    <!-- MQTT Library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            --bg-color: #2c3e50; /* Dark Slate */
            --header-bg: #27ae60; /* Football Green */
            --card-bg: #ffffff;
            --primary: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* HEADER */
        .top-bar {
            background: var(--header-bg);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .top-bar h1 { margin: 0; font-size: 1.5rem; }
        .room-badge { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; font-family: monospace; }

        /* THEME SELECTOR (DECORATION ONLY) */
        .theme-selector {
            font-size: 0.9rem;
        }
        .theme-selector select {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 5px;
            border-radius: 4px;
        }

        /* LOBBY */
        #lobby-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
        }
        .lobby-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
        }
        .lobby-card h2 { margin-top: 0; color: var(--primary); }
        .input-row { margin: 15px 0; text-align: left; }
        .input-row label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .input-row input, .input-row select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-host { background-color: #27ae60; color: white; }
        .btn-host:hover { background-color: #219150; }
        .btn-join { background-color: #2980b9; color: white; }
        .btn-join:hover { background-color: #2471a3; }
        
        .divider { margin: 20px 0; border-top: 1px solid #eee; position: relative; }
        .divider span { position: absolute; top: -10px; left: 45%; background: white; padding: 0 10px; color: #999; font-size: 0.8rem; }

        /* GAME AREA */
        #game-screen { padding: 20px; display: none; }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .bingo-card {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .card-title {
            background: #333; /* Default Theme Color */
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            border-top: 1px solid #ccc;
            aspect-ratio: 1/1;
        }

        .cell {
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 11px;
            padding: 2px;
            user-select: none;
            cursor: pointer;
            position: relative;
            background: #fff;
        }
        .cell:active { background: #f0f0f0; }

        .cell.free-space {
            background: #333 !important; /* Theme Color */
            color: white !important;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .cell.marked {
            background-color: rgba(39, 174, 96, 0.8); /* Green marker */
            color: white;
            text-decoration: line-through;
        }
        .cell.winning-cell {
            background-color: #f1c40f !important; /* Gold */
            color: black !important;
            text-decoration: none;
            font-weight: bold;
        }

        /* SCOREBOARD */
        #scoreboard {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            min-width: 200px;
            z-index: 100;
            display: none;
        }
        #scoreboard h4 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .score-entry { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .score-entry.has-bingo { color: #d35400; font-weight: bold; }

        /* ANIMATIONS */
        #celebration-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: hidden; z-index: 9999;
            display: none;
        }
        .flying-football {
            position: absolute; font-size: 3rem;
            animation: flyAcross 2s linear infinite;
        }
        @keyframes flyAcross {
            0% { transform: translateX(-100px) rotate(0deg); }
            100% { transform: translateX(110vw) rotate(720deg); }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- TOP HEADER -->
    <div class="top-bar hidden" id="game-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h1>üèà Bingo</h1>
            <span class="room-badge" id="room-display">----</span>
        </div>
        <div class="theme-selector">
            <label>Decoration:</label>
            <select id="theme-select" onchange="changeTheme()">
                <option value="None">Neutral</option>
                <!-- Teams injected by JS -->
            </select>
        </div>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen">
        <div class="lobby-card">
            <h2>NFL Bingo Party</h2>
            
            <div class="input-row">
                <label>Your Name</label>
                <input type="text" id="username" placeholder="Player Name">
            </div>

            <!-- HOST -->
            <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                <div class="input-row">
                    <label>Cards per Player</label>
                    <select id="card-count">
                        <option value="1">1 Card</option>
                        <option value="2">2 Cards</option>
                        <option value="3">3 Cards</option>
                        <option value="4">4 Cards</option>
                    </select>
                </div>
                <button class="btn-host" onclick="startHost()">Start New Game</button>
            </div>

            <div class="divider"><span>OR</span></div>

            <!-- JOIN -->
            <div class="input-row">
                <input type="text" id="join-code" placeholder="Room Code (ABCD)" maxlength="4" style="text-transform: uppercase; text-align:center; letter-spacing:2px;">
            </div>
            <button class="btn-join" onclick="startJoin()">Join Room</button>
        </div>
    </div>

    <!-- GAMEPLAY -->
    <div id="game-screen">
        <div class="card-container" id="card-area"></div>
    </div>

    <!-- HOST SCOREBOARD -->
    <div id="scoreboard">
        <h4>Scoreboard</h4>
        <div id="score-list"></div>
    </div>

    <!-- CELEBRATION -->
    <div id="celebration-layer"></div>

    <script>
        // ========================================================
        // 1. DATA
        // ========================================================
        const TEAMS = {
            "None": "#333333", "ARI": "#97233F", "ATL": "#A71930", "BAL": "#241773", 
            "BUF": "#00338D", "CAR": "#0085CA", "CHI": "#0B162A", "CIN": "#FB4F14", 
            "CLE": "#311D00", "DAL": "#041E42", "DEN": "#FB4F14", "DET": "#0076B6", 
            "GB": "#203731", "HOU": "#03202F", "IND": "#002C5F", "JAX": "#006778", 
            "KC": "#E31837", "LV": "#000000", "LAC": "#0080C6", "LAR": "#003594", 
            "MIA": "#008E97", "MIN": "#4F2683", "NE": "#002244", "NO": "#D3BC8D", 
            "NYG": "#0B2265", "NYJ": "#125740", "PHI": "#004C54", "PIT": "#FFB612", 
            "SF": "#AA0000", "SEA": "#002244", "TB": "#D50A0A", "TEN": "#0C2340", 
            "WAS": "#5A1414"
        };

        const EVENT_POOL = [
            "Touchdown", "Field Goal", "First Down", "2-Pt Conv", "QB Scramble", "4th Down Try", 
            "Pass > 20 Yds", "Run > 10 Yds", "3rd & Long", "Screen > 10", "Play Action", "QB Sneak", 
            "Hail Mary", "Empty Backfield", "Shotgun", "Trick Play", "Fake Punt", "Sack", "TFL", 
            "Pass Defended", "Tipped Pass", "Thrown Away", "Interception", "Fumble", "Turnover on Downs", 
            "Defensive TD", "Goal Line Stand", "3-and-Out", "Red Zone Stop", "Blocked Kick", "Penalty Flag", 
            "Holding", "False Start", "Pass Interference", "Delay of Game", "Intentional Grounding", 
            "Roughing Passer", "Face Mask", "Timeout", "2-Min Warning", "Challenge Flag", "Measurement", 
            "Overtime", "Injury", "Coach Yelling", "Mascot", "Blimp Shot", "Face Paint", "Shirtless Fan", 
            "Truck Ad", "Beer Ad", "Helmet Throw", "Cheerleader", "Celebrity", "Hurdle", "Juke", "One-Handed Catch"
        ];

        const WINS = [
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], 
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], 
            [0,6,12,18,24], [4,8,12,16,20]
        ];

        // ========================================================
        // 2. SETUP
        // ========================================================
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const TOPIC_PREFIX = 'nflbingo_v5';

        // Init Theme Select
        const themeSel = document.getElementById('theme-select');
        for(let t in TEAMS) {
            if(t !== "None") {
                let opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                themeSel.appendChild(opt);
            }
        }

        // State
        let client;
        let myId = 'u_' + Math.random().toString(36).substr(2, 5);
        let myName = "Player";
        let roomCode = "";
        let isHost = false;
        let cardsPerPlayer = 1;
        
        let gameState = {
            players: {} // id -> { name, cards: [ { events:[], marked:[], bingo:false, winLine:[] } ] }
        };

        // ========================================================
        // 3. START LOGIC
        // ========================================================
        function startHost() {
            myName = document.getElementById('username').value.trim() || "The Host";
            cardsPerPlayer = parseInt(document.getElementById('card-count').value);
            roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
            isHost = true;

            // 1. CREATE LOCAL DATA IMMEDIATELY
            gameState.players[myId] = generatePlayerData(myName, cardsPerPlayer);

            // 2. RENDER IMMEDIATELY (No waiting for network)
            showGameUI();
            renderCards();
            renderScoreboard();

            // 3. THEN Connect
            connectNetwork();
        }

        function startJoin() {
            myName = document.getElementById('username').value.trim() || "Guest";
            roomCode = document.getElementById('join-code').value.trim().toUpperCase();
            if(roomCode.length !== 4) return alert("Invalid Room Code");
            isHost = false;

            showGameUI();
            document.getElementById('card-area').innerHTML = '<h2>Connecting to Host...</h2>';
            
            connectNetwork();
        }

        function showGameUI() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-header').classList.remove('hidden');
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('room-display').textContent = "Room: " + roomCode;
            if(isHost) document.getElementById('scoreboard').style.display = 'block';
        }

        // ========================================================
        // 4. GAME LOGIC
        // ========================================================
        function generatePlayerData(name, count) {
            let p = { name: name, cards: [] };
            for(let i=0; i<count; i++) {
                let evts = [...EVENT_POOL].sort(() => Math.random() - 0.5).slice(0, 24);
                evts.splice(12, 0, "FREE SPACE");
                p.cards.push({
                    events: evts,
                    marked: [12],
                    bingo: false,
                    winLine: []
                });
            }
            return p;
        }

        function checkBingo(card) {
            for(let line of WINS) {
                if(line.every(idx => card.marked.includes(idx))) return line;
            }
            return null;
        }

        // ========================================================
        // 5. RENDER LOGIC
        // ========================================================
        function renderCards() {
            const container = document.getElementById('card-area');
            const myData = gameState.players[myId];
            
            if(!myData) return; // Waiting for sync

            // Simple clear and rebuild to prevent any syncing glitches
            container.innerHTML = '';

            myData.cards.forEach((card, cIdx) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'bingo-card';
                
                const header = document.createElement('div');
                header.className = 'card-title';
                // Theme color application
                const themeColor = TEAMS[document.getElementById('theme-select').value] || TEAMS["None"];
                header.style.backgroundColor = themeColor;
                
                header.innerHTML = `<span>${myData.name} #${cIdx+1}</span> ${card.bingo ? '<span>üèÜ BEANO!</span>' : ''}`;
                cardDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'grid';

                card.events.forEach((txt, idx) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.textContent = txt;

                    if(idx === 12) {
                        cell.classList.add('free-space');
                        cell.style.backgroundColor = themeColor;
                    }
                    if(card.marked.includes(idx)) cell.classList.add('marked');
                    if(card.winLine.includes(idx)) cell.classList.add('winning-cell');

                    // Click Handler
                    cell.onclick = () => {
                        if(idx === 12) return;
                        
                        // Optimistic Update
                        if(card.marked.includes(idx)) card.marked = card.marked.filter(i => i !== idx);
                        else card.marked.push(idx);

                        // Check Win
                        const win = checkBingo(card);
                        if(win) {
                            card.bingo = true;
                            card.winLine = win;
                            if(!card.hasAnnounced) {
                                triggerCelebration();
                                card.hasAnnounced = true;
                            }
                        } else {
                            card.bingo = false;
                            card.winLine = [];
                        }

                        // Re-render locally immediately
                        renderCards();
                        if(isHost) renderScoreboard();

                        // Send to network
                        send({ type: 'UPDATE_PLAYER', pData: myData });
                    };

                    grid.appendChild(cell);
                });

                cardDiv.appendChild(grid);
                container.appendChild(cardDiv);
            });
        }

        function renderScoreboard() {
            const list = document.getElementById('score-list');
            list.innerHTML = '';
            Object.values(gameState.players).forEach(p => {
                let bingos = p.cards.filter(c => c.bingo).length;
                let div = document.createElement('div');
                div.className = 'score-entry';
                if(bingos > 0) div.classList.add('has-bingo');
                div.innerHTML = `<span>${p.name}</span> <span>${bingos > 0 ? 'üèÜ ' + bingos : '...'}</span>`;
                list.appendChild(div);
            });
        }

        function changeTheme() {
            // Just re-render to apply colors
            renderCards();
            // Optional: Send theme change to others? The user said it's decoration only.
            // But if we want everyone to see the theme:
            if(isHost) send({ type: 'THEME', theme: document.getElementById('theme-select').value });
        }

        function triggerCelebration() {
            const layer = document.getElementById('celebration-layer');
            layer.style.display = 'block';
            layer.innerHTML = ''; // clear old balls
            
            for(let i=0; i<15; i++) {
                let fb = document.createElement('div');
                fb.textContent = 'üèà';
                fb.className = 'flying-football';
                fb.style.top = Math.random() * 100 + '%';
                fb.style.animationDuration = (Math.random() * 2 + 1) + 's';
                fb.style.animationDelay = Math.random() + 's';
                layer.appendChild(fb);
            }

            setTimeout(() => { layer.style.display = 'none'; }, 4000);
        }

        // ========================================================
        // 6. NETWORK LOGIC
        // ========================================================
        function connectNetwork() {
            client = mqtt.connect(MQTT_BROKER);
            const topic = `${TOPIC_PREFIX}/${roomCode}`;
            
            client.on('connect', () => {
                console.log("Connected", topic);
                client.subscribe(topic);

                if(!isHost) {
                    // Guest: Ask to join
                    const loop = setInterval(() => {
                        if(gameState.players[myId]) clearInterval(loop);
                        else send({ type: 'JOIN', name: myName });
                    }, 2000);
                } else {
                    // Host: Heartbeat state
                    setInterval(() => {
                        send({ type: 'STATE', state: gameState });
                    }, 1000);
                }
            });

            client.on('message', (t, msg) => {
                const data = JSON.parse(msg.toString());
                if(data.sender === myId) return;

                if(isHost) {
                    // HOST HANDLES JOINS & UPDATES
                    if(data.type === 'JOIN') {
                        if(!gameState.players[data.sender]) {
                            gameState.players[data.sender] = generatePlayerData(data.name, cardsPerPlayer);
                        }
                    }
                    if(data.type === 'UPDATE_PLAYER') {
                        // Merge guest progress
                        gameState.players[data.sender] = data.pData;
                        renderScoreboard();
                        // If they won, trigger celebration for host too?
                        if(data.pData.cards.some(c => c.bingo)) triggerCelebration();
                    }
                } else {
                    // GUEST RECEIVES STATE
                    if(data.type === 'STATE') {
                        // Only overwrite if we haven't joined yet or it's a sync
                        // Caution: Don't overwrite my own clicks with old server data
                        // Strategy: Merge everyone else, keep my own unless initial load
                        
                        const myLocal = gameState.players[myId];
                        gameState = data.state; // Bulk update
                        
                        if(myLocal) {
                            // Restore my local state to ensure smoothness
                            gameState.players[myId] = myLocal; 
                        }
                        
                        // If host changed theme
                        if(data.theme) document.getElementById('theme-select').value = data.theme;

                        renderCards();
                        if(gameState.players[myId] && gameState.players[myId].cards.some(c => c.bingo && !c.hasAnnounced)) {
                             triggerCelebration(); // Delayed sync celebration
                        }
                    }
                    if(data.type === 'THEME') {
                         document.getElementById('theme-select').value = data.theme;
                         renderCards();
                    }
                }
            });
        }

        function send(payload) {
            payload.sender = myId;
            client.publish(`${TOPIC_PREFIX}/${roomCode}`, JSON.stringify(payload));
        }

    </script>
</body>
</html>
